<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Tap2Serve</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1"
        rel="stylesheet" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#c9a24d",
                        "primary-dark": "#a08036",
                        "bg-deep": "#0b0b0b",
                        "bg-soft": "#1a1a1a",
                        "bg-card": "#141414",
                        "text-main": "#ffffff",
                        "text-muted": "#b5b5b5",
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(201, 162, 77, 0.1)',
                    }
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b0b0b;
            color: #fff;
        }

        .glass-panel {
            background: rgba(26, 26, 26, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .sidebar-link {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            background: rgba(201, 162, 77, 0.1);
            color: #c9a24d;
            border-right: 3px solid #c9a24d;
        }

        .sidebar-link.active i {
            color: #c9a24d;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0b0b0b;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #c9a24d;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            border-color: rgba(201, 162, 77, 0.3);
        }

        /* View transition */
        .view-section {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden selection:bg-primary selection:text-black">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-bg-soft border-r border-white/5 flex flex-col hidden md:flex">
        <div class="h-20 flex items-center px-8 border-b border-white/5">
            <span class="material-symbols-outlined text-primary text-3xl mr-2">restaurant_menu</span>
            <h1 class="text-xl font-bold tracking-tight text-white">Tap2Serve</h1>
        </div>

        <nav class="flex-1 py-8 flex flex-col gap-1">
            <!-- Alert Panel for Waiter Calls -->
            <div id="waiter-alert-panel"
                class="hidden mx-4 mb-4 bg-red-500/20 border border-red-500/50 rounded-lg p-3 animate-pulse">
                <div class="flex justify-between items-center text-red-500 font-bold text-sm mb-2">
                    <span>Waiter Called!</span>
                    <button onclick="fetchWaiterCalls()" class="text-white hover:text-red-200"><span
                            class="material-symbols-outlined">refresh</span></button>
                </div>
                <div id="waiter-alert-list" class="space-y-2 max-h-32 overflow-y-auto">
                    <!-- Calls Injected -->
                </div>
            </div>

            <div class="px-4 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Main</div>

            <a onclick="switchTab('dashboard')" id="nav-dashboard"
                class="sidebar-link active flex items-center gap-4 px-8 py-3 text-sm font-medium text-gray-300">
                <span class="material-symbols-outlined text-[20px]">dashboard</span>
                Dashboard
            </a>
            <a onclick="switchTab('orders')" id="nav-orders"
                class="sidebar-link flex items-center gap-4 px-8 py-3 text-sm font-medium text-gray-300">
                <span class="material-symbols-outlined text-[20px]">orders</span>
                Live Orders
                <span class="ml-auto text-[10px] bg-primary text-black font-bold px-2 py-0.5 rounded-full">12</span>
            </a>
            <a onclick="switchTab('menu')" id="nav-menu"
                class="sidebar-link flex items-center gap-4 px-8 py-3 text-sm font-medium text-gray-300">
                Menu Management
            </a>
            <a onclick="switchTab('inventory')" id="nav-inventory"
                class="sidebar-link flex items-center gap-4 px-8 py-3 text-sm font-medium text-gray-300">
                <span class="material-symbols-outlined text-[20px]">inventory_2</span>
                Inventory
            </a>
            <a onclick="switchTab('history')" id="nav-history"
                class="sidebar-link flex items-center gap-4 px-8 py-3 text-sm font-medium text-gray-300">
                <span class="material-symbols-outlined text-[20px]">history</span>
                Order History
            </a>
            <a onclick="switchTab('reservations')" id="nav-reservations"
                class="sidebar-link flex items-center gap-4 px-8 py-3 text-sm font-medium text-gray-300">
                <span class="material-symbols-outlined text-[20px]">event_seat</span>
                Reservations
            </a>
            <a onclick="switchTab('kds')" id="nav-kds"
                class="sidebar-link flex items-center gap-4 px-8 py-3 text-sm font-medium text-gray-300">
                <span class="material-symbols-outlined text-[20px]">soup_kitchen</span>
                Kitchen Panel
            </a>
            <a onclick="switchTab('tables')" id="nav-tables"
                class="sidebar-link flex items-center gap-4 px-8 py-3 text-sm font-medium text-gray-300">
                <span class="material-symbols-outlined text-[20px]">table_bar</span>
                Tables & Zones
            </a>

            <div class="px-4 mt-8 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Analytics</div>
            <a onclick="switchTab('reports')" id="nav-reports"
                class="sidebar-link flex items-center gap-4 px-8 py-3 text-sm font-medium text-gray-300">
                <span class="material-symbols-outlined text-[20px]">monitoring</span>
                Sales Reports
            </a>
            <a onclick="switchTab('transactions')" id="nav-transactions"
                class="sidebar-link flex items-center gap-4 px-8 py-3 text-sm font-medium text-gray-300">
                <span class="material-symbols-outlined text-[20px]">receipt_long</span>
                Transactions
            </a>
        </nav>

        <div class="p-4 border-t border-white/5">
            <a href="index.html"
                class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/5 transition-colors text-sm text-gray-400 hover:text-white">
                <span class="material-symbols-outlined">logout</span>
                Sign Out
            </a>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col min-w-0 overflow-hidden bg-bg-deep relative">
        <!-- Background Glow -->
        <div
            class="absolute top-0 right-0 w-[500px] h-[500px] bg-primary/5 rounded-full blur-[120px] pointer-events-none">
        </div>

        <!-- HEADER -->
        <header
            class="h-20 border-b border-white/5 flex items-center justify-between px-8 bg-bg-deep/50 backdrop-blur-md z-10">
            <h2 id="page-title" class="text-xl font-semibold text-white">Overview</h2>

            <div class="flex items-center gap-6">
                <!-- Search -->
                <div class="relative hidden md:block">
                    <span
                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-lg">search</span>
                    <input type="text" placeholder="Search..."
                        class="bg-bg-soft border border-white/10 rounded-full pl-10 pr-4 py-2 text-sm text-gray-300 focus:outline-none focus:border-primary/50 w-64 transition-colors">
                </div>

                <!-- Icons -->
                <button class="relative text-gray-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">notifications</span>
                    <span class="absolute top-0 right-0 size-2 bg-red-500 rounded-full border border-bg-deep"></span>
                </button>

                <!-- Profile -->
                <div class="flex items-center gap-3 pl-6 border-l border-white/5">
                    <div class="text-right hidden md:block">
                        <p class="text-sm font-medium text-white">Restaurant Manager</p>
                        <p class="text-xs text-primary">Admin</p>
                    </div>
                    <div class="size-10 rounded-full bg-gradient-to-tr from-primary to-primary-dark p-[2px]">
                        <img src="https://ui-avatars.com/api/?name=Admin+User&background=0b0b0b&color=fff"
                            class="rounded-full w-full h-full object-cover border-2 border-bg-deep">
                    </div>
                </div>
            </div>
        </header>

        <!-- SCROLLABLE CONTENT AREA -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth relative">

            <!-- ================= VIEW: DASHBOARD ================= -->
            <div id="view-dashboard" class="view-section active">
                <!-- STATS GRID -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Stat 1 -->
                    <!-- Stat 1 -->
                    <div class="glass-panel p-6 rounded-2xl stat-card transition-all duration-300">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-primary/10 rounded-lg text-primary">
                                <span class="material-symbols-outlined">payments</span>
                            </div>
                            <!-- Dynamic Percentage Placeholder -->
                            <span class="text-gray-500 text-xs font-bold flex items-center" id="revenue-growth">
                                --
                            </span>
                        </div>
                        <h3 class="text-gray-400 text-sm font-medium">Total Revenue</h3>
                        <p id="stat-revenue" class="text-2xl font-bold text-white mt-1">₹0</p>
                    </div>
                    <!-- Stat 2 -->
                    <div class="glass-panel p-6 rounded-2xl stat-card transition-all duration-300">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-blue-500/10 rounded-lg text-blue-500">
                                <span class="material-symbols-outlined">shopping_bag</span>
                            </div>
                            <span class="text-gray-500 text-xs font-bold flex items-center" id="orders-growth">
                                --
                            </span>
                        </div>
                        <h3 class="text-gray-400 text-sm font-medium">Total Orders</h3>
                        <p id="stat-orders" class="text-2xl font-bold text-white mt-1">0</p>
                    </div>
                    <!-- Stat 3 -->
                    <div class="glass-panel p-6 rounded-2xl stat-card transition-all duration-300">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-purple-500/10 rounded-lg text-purple-500">
                                <span class="material-symbols-outlined">groups</span>
                            </div>
                            <span class="text-gray-500 text-xs font-bold">Today</span>
                        </div>
                        <h3 class="text-gray-400 text-sm font-medium">Active Guests</h3>
                        <p id="stat-guests" class="text-2xl font-bold text-white mt-1">0</p>
                    </div>
                    <!-- Stat 4 -->
                    <div class="glass-panel p-6 rounded-2xl stat-card transition-all duration-300">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-orange-500/10 rounded-lg text-orange-500">
                                <span class="material-symbols-outlined">timelapse</span>
                            </div>
                            <span class="text-gray-500 text-xs font-bold flex items-center">
                                --
                            </span>
                        </div>
                        <h3 class="text-gray-400 text-sm font-medium">Avg. Prep Time</h3>
                        <p class="text-2xl font-bold text-white mt-1">0 min</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- LIVE KITCHEN (2/3 width) -->
                    <div class="lg:col-span-2 flex flex-col gap-6">
                        <!-- Chart Placeholder -->
                        <div class="glass-panel p-6 rounded-2xl border border-white/5">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-lg font-bold text-white">Revenue Analytics</h3>
                                <button
                                    class="text-xs bg-white/5 hover:bg-white/10 text-gray-300 px-3 py-1 rounded-md transition-colors">This
                                    Week</button>
                            </div>
                            <!-- Mock Chart Bars -->
                            <div class="h-64 flex items-end justify-between gap-2 px-2" id="revenue-chart-container">
                                <!-- Bars will be injected by JS -->
                                <div class="w-full h-full flex items-center justify-center text-gray-600 text-xs">
                                    No data available
                                </div>
                            </div>
                            <div
                                class="flex justify-between mt-4 text-xs text-gray-500 font-medium uppercase tracking-wider">
                                <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span
                                    class="text-primary">Sat</span><span>Sun</span>
                            </div>
                        </div>

                        <!-- Recent Orders Table -->
                        <div class="glass-panel rounded-2xl overflow-hidden border border-white/5">
                            <div class="p-6 border-b border-white/5 flex justify-between items-center">
                                <h3 class="text-lg font-bold text-white">Recent Orders</h3>
                                <a onclick="switchTab('orders')"
                                    class="text-primary text-sm hover:underline cursor-pointer">View All</a>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead class="bg-white/5 text-gray-400 text-xs uppercase font-semibold">
                                        <tr>
                                            <th class="px-6 py-4">Order ID</th>
                                            <th class="px-6 py-4">Table</th>
                                            <th class="px-6 py-4">Items</th>
                                            <th class="px-6 py-4">Status</th>
                                            <th class="px-6 py-4 text-right">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-orders-body"
                                        class="divide-y divide-white/5 text-sm text-gray-300">
                                        <!-- JS Injected -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN -->
                    <div class="flex flex-col gap-6">
                        <!-- Kitchen Status -->
                        <div class="glass-panel p-6 rounded-2xl border border-white/5">
                            <h3 class="text-lg font-bold text-white mb-4">Kitchen Load</h3>
                            <div class="flex items-center gap-4 mb-6">
                                <div
                                    class="size-16 rounded-full border-4 border-gray-700 border-t-primary flex items-center justify-center">
                                    <span class="text-lg font-bold text-white" id="kitchen-load-value">0%</span>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-white" id="kitchen-load-status">Low Demand</p>
                                    <p class="text-xs text-gray-400" id="kitchen-load-delay">Est. delay: 0 mins</p>
                                </div>
                            </div>
                        </div>

                        <!-- Top Selling Items -->
                        <div class="glass-panel p-6 rounded-2xl border border-white/5 flex-1">
                            <h3 class="text-lg font-bold text-white mb-4">Trending Dishes</h3>
                            <div class="space-y-4" id="trending-dishes-container">
                                <p class="text-gray-500 text-xs text-center py-4">Not enough data yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= VIEW: LIVE ORDERS (KANBAN) ================= -->
            <div id="view-orders" class="view-section">
                <!-- Kanban Board -->
                <div class="flex gap-4 h-[calc(100vh-140px)] overflow-x-auto pb-4">
                    <!-- Column: NEW -->
                    <div class="flex-shrink-0 w-80 flex flex-col bg-white/5 rounded-xl border border-white/5 h-full">
                        <div
                            class="p-4 border-b border-white/5 flex justify-between items-center bg-white/5 rounded-t-xl">
                            <h3 class="font-bold text-white flex items-center gap-2">
                                <span class="size-2 rounded-full bg-blue-500"></span> New Orders
                            </h3>
                            <span id="count-new" class="text-xs bg-bg-deep px-2 py-1 rounded text-gray-400">0</span>
                        </div>
                        <div id="col-new" class="p-3 flex-1 overflow-y-auto space-y-3">
                            <!-- JS Injected -->
                        </div>
                    </div>

                    <!-- Column: COOKING -->
                    <div class="flex-shrink-0 w-80 flex flex-col bg-white/5 rounded-xl border border-white/5 h-full">
                        <div
                            class="p-4 border-b border-white/5 flex justify-between items-center bg-white/5 rounded-t-xl">
                            <h3 class="font-bold text-white flex items-center gap-2">
                                <span class="size-2 rounded-full bg-yellow-500"></span> Cooking
                            </h3>
                            <span id="count-cooking" class="text-xs bg-bg-deep px-2 py-1 rounded text-gray-400">0</span>
                        </div>
                        <div id="col-cooking" class="p-3 flex-1 overflow-y-auto space-y-3">
                            <!-- JS Injected -->
                        </div>
                    </div>

                    <!-- Column: READY -->
                    <div class="flex-shrink-0 w-80 flex flex-col bg-white/5 rounded-xl border border-white/5 h-full">
                        <div
                            class="p-4 border-b border-white/5 flex justify-between items-center bg-white/5 rounded-t-xl">
                            <h3 class="font-bold text-white flex items-center gap-2">
                                <span class="size-2 rounded-full bg-green-500"></span> Ready
                            </h3>
                            <span id="count-ready" class="text-xs bg-bg-deep px-2 py-1 rounded text-gray-400">0</span>
                        </div>
                        <div id="col-ready" class="p-3 flex-1 overflow-y-auto space-y-3">
                            <!-- JS Injected -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= VIEW: INVENTORY ================= -->
            <div id="view-inventory" class="view-section">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white">Inventory Management</h3>
                    <button onclick="fetchInventory()" class="text-primary hover:text-white"><span
                            class="material-symbols-outlined">refresh</span></button>
                </div>
                <div class="glass-panel rounded-xl overflow-hidden border border-white/5">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-white/5 uppercase text-xs text-primary">
                            <tr>
                                <th class="px-6 py-4">Item Name</th>
                                <th class="px-6 py-4">Stock Level</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-body" class="divide-y divide-white/5">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ================= VIEW: HISTORY ================= -->
            <div id="view-history" class="view-section">
                <div class="flex gap-4 mb-6">
                    <input type="date" id="hist-date-from"
                        class="bg-bg-soft border border-white/10 rounded px-3 py-2 text-sm text-white focus:border-primary focus:outline-none">
                    <input type="date" id="hist-date-to"
                        class="bg-bg-soft border border-white/10 rounded px-3 py-2 text-sm text-white focus:border-primary focus:outline-none">
                    <select id="hist-status"
                        class="bg-bg-soft border border-white/10 rounded px-3 py-2 text-sm text-white focus:border-primary focus:outline-none">
                        <option value="">All Statuses</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                        <option value="Paid">Paid</option>
                    </select>
                    <button onclick="fetchHistory()"
                        class="bg-primary text-black font-bold px-4 py-2 rounded text-sm hover:bg-white transition-colors">Apply
                        Filters</button>
                </div>

                <div class="glass-panel rounded-xl overflow-hidden border border-white/5">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-white/5 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-4">Date</th>
                                <th class="px-6 py-4">Order ID</th>
                                <th class="px-6 py-4">Table</th>
                                <th class="px-6 py-4">Items</th>
                                <th class="px-6 py-4">Total</th>
                                <th class="px-6 py-4">Status</th>
                            </tr>
                        </thead>
                        <tbody id="history-body" class="divide-y divide-white/5">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ================= VIEW: RESERVATIONS ================= -->
            <div id="view-reservations" class="view-section">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white">Table Reservations</h3>
                    <button onclick="fetchReservations()" class="text-primary hover:text-white"><span
                            class="material-symbols-outlined">refresh</span></button>
                </div>
                <div class="glass-panel rounded-xl overflow-hidden border border-white/5">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-white/5 uppercase text-xs text-primary">
                            <tr>
                                <th class="px-6 py-4">Time</th>
                                <th class="px-6 py-4">Guest Name</th>
                                <th class="px-6 py-4">Party Size</th>
                                <th class="px-6 py-4">Table</th>
                                <th class="px-6 py-4">Contact</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="reservations-body" class="divide-y divide-white/5">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ================= VIEW: RESERVATIONS ================= -->
            <!-- ... (existing) ... -->

            <!-- ================= VIEW: KDS (Kitchen Display System) ================= -->
            <div id="view-kds" class="view-section">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-white tracking-wider">KITCHEN DISPLAY</h3>
                    <div class="flex gap-4">
                        <div class="flex items-center gap-2 bg-gray-800 px-3 py-1 rounded-lg border border-white/10">
                            <span class="text-xs text-gray-400">Prep:</span>
                            <input type="number" id="prep-time-input" value="20"
                                class="w-8 bg-transparent text-white text-center font-bold focus:outline-none"
                                onchange="updatePrepTime(this.value)">
                            <span class="text-xs text-gray-500">m</span>
                        </div>
                        <span class="flex items-center gap-2 text-gray-400 text-sm">
                            <span class="size-3 bg-red-500 rounded-full animate-pulse"></span> Live Sync
                        </span>
                        <button onclick="fetchKDS()" class="text-primary hover:text-white"><span
                                class="material-symbols-outlined">refresh</span></button>
                    </div>
                </div>

                <div id="kds-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- KDS Tickets Injected Here -->
                </div>
            </div>

            <!-- ================= VIEW: MENU MANAGEMENT ================= -->
            <div id="view-menu" class="view-section">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex gap-4">
                        <button onclick="promptAddMenu()"
                            class="bg-primary text-black px-4 py-2 rounded-lg font-bold text-sm hover:bg-white transition-colors">Add
                            New Item</button>
                        <select
                            class="bg-bg-soft border border-white/10 rounded-lg px-4 py-2 text-sm text-gray-300 focus:outline-none focus:border-primary">
                            <option>All Categories</option>
                            <option>Main Course</option>
                            <option>Starters</option>
                            <option>Drinks</option>
                        </select>
                    </div>
                </div>

                <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- JS Injected -->
                </div>
            </div>

            <!-- ================= VIEW: TABLES ================= -->
            <div id="view-tables" class="view-section">
                <div class="flex gap-8">
                    <!-- Legend -->
                    <div class="w-64 flex-shrink-0 glass-panel p-6 rounded-xl h-fit">
                        <h3 class="font-bold text-white mb-4">Legend</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex items-center gap-3">
                                <span class="size-4 rounded bg-green-500/20 border border-green-500"></span>
                                <span class="text-gray-300">Available</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="size-4 rounded bg-red-500/20 border border-red-500"></span>
                                <span class="text-gray-300">Occupied</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="size-4 rounded bg-orange-500/20 border border-orange-500"></span>
                                <span class="text-gray-300">Reserved</span>
                            </div>
                        </div>
                        <div class="mt-8">
                            <h3 class="font-bold text-white mb-2">Table Settings</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs text-gray-400">Total Tables</label>
                                    <div class="flex gap-2">
                                        <input type="number" id="table-count-input"
                                            class="w-full bg-white/5 border border-white/10 rounded px-2 py-1 text-sm text-white focus:outline-none focus:border-primary"
                                            placeholder="10">
                                        <button onclick="updateTableCount()"
                                            class="bg-primary text-black text-xs font-bold px-3 py-1 rounded hover:bg-white transition-colors">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs text-gray-400">Print QR Range</label>
                            <div class="flex gap-2 mb-2">
                                <input type="number" id="qr-start"
                                    class="w-1/2 bg-white/5 border border-white/10 rounded px-2 py-1 text-sm text-white focus:outline-none focus:border-primary"
                                    placeholder="Start" value="1">
                                <input type="number" id="qr-end"
                                    class="w-1/2 bg-white/5 border border-white/10 rounded px-2 py-1 text-sm text-white focus:outline-none focus:border-primary"
                                    placeholder="End" value="10">
                            </div>
                            <div class="mb-2">
                                <label class="text-xs text-gray-400">Server IP/Host</label>
                                <input type="text" id="qr-host"
                                    class="w-full bg-white/5 border border-white/10 rounded px-2 py-1 text-sm text-white focus:outline-none focus:border-primary"
                                    placeholder="e.g. 192.168.1.5:5000">
                                <p class="text-[10px] text-gray-500 mt-1">Run 'ipconfig' to find your IP for mobile
                                    scanning.</p>
                            </div>
                            <button onclick="printQRCodes()"
                                class="w-full bg-white/5 hover:bg-white/10 text-gray-300 text-sm py-2 rounded flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">qr_code_2</span> Print Selected
                            </button>
                        </div>
                        <button onclick="showAlert('Select two adjacent tables to merge.')"
                            class="w-full bg-white/5 hover:bg-white/10 text-gray-300 text-sm py-2 rounded">Merge
                            Tables</button>
                    </div>
                </div>
            </div>

            <!-- Layout Grid -->
            <div class="flex-1 glass-panel p-8 rounded-xl min-h-[600px] relative bg-grid-pattern">
                <!-- Zones Title (Absolute for visuals) -->
                <div class="absolute top-4 left-8 text-gray-500 font-bold uppercase tracking-widest text-xs">
                    Main Dining Hall</div>

                <div id="tables-grid" class="grid grid-cols-4 gap-12 mt-8">
                    <!-- JS Injected Tables -->
                </div>
            </div>
        </div>
        </div>

        <!-- ================= VIEW: REPORTS ================= -->
        <div id="view-reports" class="view-section">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="font-bold text-white mb-4">Weekly Sales</h3>
                    <!-- Pure CSS Bar Chart (Mock) -->
                    <div class="flex items-end justify-between h-64 gap-2 pt-4 border-t border-white/5"
                        id="weekly-sales-chart">
                        <div class="w-full h-full flex items-center justify-center text-gray-600 text-xs">No data
                            available</div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-2 font-mono">
                        <span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span><span>S</span>
                    </div>
                </div>
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="font-bold text-white mb-4">Order Sources</h3>
                    <div class="flex items-center justify-center h-64" id="order-sources-chart">
                        <p class="text-gray-500 text-xs">No data available</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= VIEW: TRANSACTIONS ================= -->
        <div id="view-transactions" class="view-section">
            <div class="glass-panel rounded-xl overflow-hidden border border-white/5">
                <div class="p-6 border-b border-white/5">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-0 gap-4">
                        <h3 class="font-bold text-white">Transaction History</h3>
                        <div class="flex gap-2 items-center">
                            <input type="date" id="txn-date-from" placeholder="From"
                                class="bg-black/20 border border-white/10 text-white text-xs rounded px-2 py-1.5 focus:outline-none focus:border-primary">
                            <span class="text-gray-500">-</span>
                            <input type="date" id="txn-date-to" placeholder="To"
                                class="bg-black/20 border border-white/10 text-white text-xs rounded px-2 py-1.5 focus:outline-none focus:border-primary">
                            <button onclick="fetchTransactions()"
                                class="bg-primary/10 hover:bg-primary/20 text-primary border border-primary/20 p-1.5 rounded transition-colors">
                                <span class="material-symbols-outlined text-sm">filter_list</span>
                            </button>
                        </div>
                        <button onclick="exportTransactions()"
                            class="text-xs bg-white/5 border border-white/10 hover:bg-white/10 text-gray-300 px-3 py-1.5 rounded flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">download</span> Export CSV
                        </button>
                    </div>
                </div>
                <table class="w-full text-left text-sm text-gray-400">
                    <thead class="bg-white/5 uppercase text-xs">
                        <tr>
                            <th class="px-6 py-4">Transaction ID</th>
                            <th class="px-6 py-4">Date</th>
                            <th class="px-6 py-4">Method</th>
                            <th class="px-6 py-4">Status</th>
                            <th class="px-6 py-4 text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body" class="divide-y divide-white/5">
                        <!-- JS Injected -->
                    </tbody>
                </table>
            </div>
        </div>

        </div>
        <!-- GENERIC MODAL -->
        <div id="generic-modal" class="fixed inset-0 z-[100] hidden">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop">
            </div>
            <!-- Content -->
            <div class="absolute inset-0 flex items-center justify-center p-4 z-10 pointer-events-none">
                <div id="modal-panel"
                    class="bg-[#1a1a1a] border border-white/10 rounded-2xl w-full max-w-md transform scale-95 opacity-0 transition-all duration-300 shadow-2xl relative overflow-hidden pointer-events-auto">
                    <!-- Header -->
                    <div class="px-6 py-4 border-b border-white/5 flex justify-between items-center bg-white/5">
                        <h3 id="modal-title" class="text-lg font-bold text-white tracking-tight">Modal Title</h3>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-white transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <!-- Body -->
                    <div class="p-6 space-y-4" id="modal-body">
                        <!-- Dynamic Inputs -->
                    </div>
                    <!-- Footer -->
                    <div class="px-6 py-4 border-t border-white/5 flex justify-end gap-3 bg-white/5">
                        <button onclick="closeModal()"
                            class="px-4 py-2 text-xs font-bold text-gray-400 hover:text-white transition-colors">Cancel</button>
                        <button id="modal-submit-btn"
                            class="bg-primary text-black px-6 py-2 rounded text-xs font-bold hover:bg-white transition-colors shadow-lg shadow-primary/20 cursor-pointer">Submit</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOTIFICATION TOAST (New Addition for feedback) -->
        <div id="toast-container" class="fixed bottom-8 right-8 z-50 flex flex-col gap-2"></div>
    </main>

    <script>
        // --- AUTHENTICATION & DATA ISOLATION ---
        const userSession = localStorage.getItem('user');
        let currentUser = null;

        try {
            currentUser = JSON.parse(userSession);
        } catch (e) {
            console.error("Invalid session");
        }

        if (!currentUser || !currentUser.id) {
            window.location.href = "../Final-login-Page/index.html"; // Redirect to login
        }

        // Global Fetch Interceptor to inject JWT Token (Standard Auth)
        const originalFetch = window.fetch;
        window.fetch = function (url, options = {}) {
            const token = localStorage.getItem('token');
            options.headers = options.headers || {};

            if (token) {
                if (options.headers instanceof Headers) {
                    options.headers.set('Authorization', `Bearer ${token}`);
                } else {
                    options.headers['Authorization'] = `Bearer ${token}`;
                }
            }

            return originalFetch(url, options);
        };

        // Update Profile Info in UI
        document.addEventListener("DOMContentLoaded", () => {
            const nameEl = document.querySelector(".text-right .text-sm");
            const roleEl = document.querySelector(".text-right .text-xs");
            // Also update avatar name if possible
            const avatarImg = document.querySelector("img[src*='ui-avatars']");

            if (nameEl) nameEl.textContent = currentUser.name || "User";
            if (roleEl) roleEl.textContent = currentUser.role || "Owner";
            if (avatarImg) {
                avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=0b0b0b&color=fff`;
            }
        });



        // Fetch Waiter Calls (New Feature)
        async function fetchWaiterCalls() {
            try {
                // Mock response if endpoint fails or returns 404
                let calls = [];
                try {
                    const res = await fetch("/api/v1/waiter/calls");
                    if (res.ok) calls = await res.json();
                } catch (e) { console.warn("Waiter API not reached"); }

                const list = document.getElementById("waiter-alert-list");
                const panel = document.getElementById("waiter-alert-panel");
                if (!list || !panel) return;

                list.innerHTML = '';
                if (calls && calls.length > 0) {
                    panel.classList.remove("hidden");
                    calls.forEach(call => {
                        const div = document.createElement("div");
                        div.className = "flex justify-between items-center text-sm bg-white/5 p-2 rounded";
                        div.innerHTML = `
                            <span class="text-white">Table ${call.tableNo}</span>
                            <span class="text-gray-400 text-xs">${new Date(call.createdAt).toLocaleTimeString()}</span>
                            <button onclick="resolveWaiterCall('${call._id}')" class="text-xs bg-red-500/20 text-red-500 px-2 py-1 rounded hover:bg-red-500 hover:text-white">Resolve</button>
                        `;
                        list.appendChild(div);
                    });
                } else {
                    panel.classList.add("hidden");
                }
            } catch (err) { console.error("Waiter calls error", err); }
        }

        async function resolveWaiterCall(id) {
            try {
                await fetch(`/api/v1/waiter/calls/${id}/resolve`, { method: 'PUT' });
                fetchWaiterCalls();
            } catch (e) { }
        }

        // Auto-poll waiter calls
        setInterval(fetchWaiterCalls, 10000);

        function switchTab(tabId) {
            // 1. Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));

            // 2. Show active view
            const activeView = document.getElementById('view-' + tabId);
            if (activeView) activeView.classList.add('active');

            // 3. Update Sidebar Active State
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + tabId).classList.add('active');

            // 4. Update Header Title
            const titles = {
                'dashboard': 'Overview',
                'orders': 'Live Kitchen Board',
                'menu': 'Menu Management',
                'tables': 'Floor Plan & Zones',
                'reports': 'Sales Analytics',
                'transactions': 'Transaction History'
            };
            document.getElementById('page-title').textContent = titles[tabId] || 'Dashboard';
        }

        // Fetch Stats
        async function fetchStats() {
            try {
                // Use Analytics Controller (Branch Aware)
                const res = await fetch("/api/v1/stats/dashboard");
                const data = await res.json();

                // 1. Core Metrics
                if (document.getElementById("stat-revenue"))
                    document.getElementById("stat-revenue").textContent = "₹" + (data.revenue ? data.revenue.toLocaleString() : "0");
                if (document.getElementById("stat-orders"))
                    document.getElementById("stat-orders").textContent = data.orders || 0;
                if (document.getElementById("stat-guests"))
                    document.getElementById("stat-guests").textContent = data.active_guests || 0;

                // Prep Time
                const prepEl = document.querySelector("#view-dashboard .text-2xl.font-bold:nth-of-type(1)"); // Or by direct ID if I added one
                const prepCard = document.querySelectorAll(".stat-card")[3];
                if (prepCard) prepCard.querySelector("p").textContent = (data.avg_prep_time || 0) + " min";

                // 2. Growth Indicators
                const renderGrowth = (id, percent) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const isPositive = percent >= 0;
                    const color = isPositive ? 'text-green-500' : 'text-red-500';
                    const icon = isPositive ? 'arrow_upward' : 'arrow_downward';
                    el.className = `${color} text-xs font-bold flex items-center`;
                    el.innerHTML = `${Math.abs(percent).toFixed(1)}% <span class="material-symbols-outlined text-[14px]">${icon}</span>`;
                };

                renderGrowth("revenue-growth", data.revenue_growth || 0);
                renderGrowth("orders-growth", data.orders_growth || 0);

                // 3. Kitchen Load
                const loadVal = document.getElementById("kitchen-load-value");
                const loadStatus = document.getElementById("kitchen-load-status");
                if (loadVal) {
                    const val = data.kitchen_load?.value || 0;
                    loadVal.textContent = val + "%";
                    // Update visual border color or spin based on load could be cool
                    // For now text update
                }
                if (loadStatus) {
                    const val = data.kitchen_load?.value || 0;
                    if (val > 80) loadStatus.textContent = "Critical Demand";
                    else if (val > 50) loadStatus.textContent = "High Demand";
                    else if (val > 20) loadStatus.textContent = "Moderate";
                    else loadStatus.textContent = "Low Demand";

                    document.getElementById("kitchen-load-delay").textContent = "Est. delay: " + (Math.ceil(val / 10) * 2) + " mins";
                }

                // 4. Trending Items
                const trendContainer = document.getElementById("trending-dishes-container");
                if (trendContainer && data.trending_items) {
                    if (data.trending_items.length === 0) {
                        trendContainer.innerHTML = '<p class="text-gray-500 text-xs text-center py-4">No top items yet.</p>';
                    } else {
                        trendContainer.innerHTML = data.trending_items.map((item, i) => `
                            <div class="flex items-center gap-3">
                                <div class="size-10 rounded-lg bg-gray-800 overflow-hidden flex items-center justify-center text-white font-bold text-xs border border-white/10">
                                    #${i + 1}
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-white">${item.name}</p>
                                    <p class="text-xs text-gray-500">${item.qty} ordered today</p>
                                </div>
                            </div>
                        `).join('');
                    }
                }

            } catch (err) {
                console.error("Failed to load stats", err);
            }
        }

        // Fetch Recent Orders (Dashboard Widget)
        async function fetchRecentOrders() {
            try {
                const res = await fetch("/api/v1/orders");
                let orders = await res.json();

                // Sort by date desc
                orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                // Take top 5
                const recent = orders.slice(0, 5);

                const tbody = document.getElementById('recent-orders-body');
                if (!tbody) return;

                tbody.innerHTML = '';

                if (recent.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500 text-xs">No recent orders</td></tr>';
                    return;
                }

                recent.forEach(order => {
                    const row = document.createElement('tr');
                    // Schema uses 'quantity', fallback to 'qty' just in case
                    const itemsSummary = order.items.map(i => `${i.quantity || i.qty || 1}x ${i.name}`).join(', ');

                    let statusColor = 'text-gray-400';
                    if (order.status === 'New') statusColor = 'text-blue-400';
                    if (order.status === 'Cooking') statusColor = 'text-orange-400';
                    if (order.status === 'Ready') statusColor = 'text-green-400';

                    // Safe Field Access
                    const orderId = order.id || order._id;
                    const tableNum = order.tableNo || order.table_no || '?';

                    row.innerHTML = `
                        <td class="px-6 py-4 font-mono text-white">#${orderId.toString().slice(-4)}</td>
                        <td class="px-6 py-4"><span class="bg-white/10 px-2 py-1 rounded text-xs text-white">Table ${tableNum}</span></td>
                        <td class="px-6 py-4 text-gray-400 truncate max-w-[150px]" title="${itemsSummary}">${itemsSummary}</td>
                        <td class="px-6 py-4"><span class="${statusColor} text-xs border border-white/10 px-2 py-1 rounded">${order.status}</span></td>
                        <td class="px-6 py-4 text-right font-bold text-primary">₹${order.total}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) { console.error("Recent orders failed", err); }
        }

        // Fetch Orders
        async function fetchOrders() {
            try {
                // Determine context
                let url = "/api/v1/orders";
                if (currentRestaurant && currentRestaurant.id) {
                    url += `?restaurantId=${currentRestaurant.id}`;
                }

                const res = await fetch(url);
                const orders = await res.json();

                // Clear Cols
                const newCol = document.getElementById("col-new");
                const cookCol = document.getElementById("col-cooking");
                const readyCol = document.getElementById("col-ready");
                if (newCol) newCol.innerHTML = '';
                if (cookCol) cookCol.innerHTML = '';
                if (readyCol) readyCol.innerHTML = '';

                let cNew = 0, cCook = 0, cReady = 0;

                if (!Array.isArray(orders)) {
                    console.error("Orders return format invalid", orders);
                    return;
                }

                orders.forEach(order => {
                    const card = document.createElement("div");
                    card.className = "glass-panel p-4 rounded-lg border border-white/10 hover:border-primary/50 transition-colors cursor-grab active:cursor-grabbing";

                    // Robust item mapping
                    let itemsHtml = "No items";
                    if (order.items && order.items.length > 0) {
                        itemsHtml = order.items.map(i => `<p>${i.quantity || i.qty || 1}x ${i.name}</p>`).join('');
                    }

                    // Field Mapping Checks
                    const orderId = order.id || order._id;
                    const orderTime = order.createdAt || order.timestamp || new Date().toISOString();
                    const tableNum = order.tableNo || order.table_no || '?';

                    let actionBtn = '';
                    let targetCol = null;

                    if (order.status === 'New') {
                        cNew++;
                        targetCol = newCol;
                        actionBtn = `<button onclick="updateStatus('${orderId}', 'Cooking')" class="text-primary hover:text-white border border-primary/20 px-2 py-1 rounded hover:bg-primary/10">Start Cooking</button>`;
                    } else if (order.status === 'Cooking') {
                        cCook++;
                        targetCol = cookCol;
                        actionBtn = `<button onclick="updateStatus('${orderId}', 'Ready')" class="text-primary hover:text-white border border-primary/20 px-2 py-1 rounded hover:bg-primary/10">Mark Ready</button>`;
                    } else if (order.status === 'Ready') {
                        cReady++;
                        targetCol = readyCol;
                        actionBtn = `<button onclick="updateStatus('${orderId}', 'Served')" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-500">Serve</button>`;
                    }

                    if (targetCol) {
                        card.innerHTML = `
                            <div class="flex justify-between mb-2">
                                <span class="font-bold text-white">#ORD-${orderId.toString().slice(-4)}</span>
                                <span class="text-xs text-gray-400">${new Date(orderTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                            <div class="text-sm text-gray-300 mb-3">${itemsHtml}</div>
                            <div class="flex justify-between items-center text-xs">
                                <span class="bg-blue-500/10 text-blue-400 px-2 py-1 rounded">Table ${tableNum}</span>
                                ${actionBtn}
                            </div>
                        `;
                        targetCol.appendChild(card);
                    }
                });

                if (document.getElementById('count-new')) document.getElementById('count-new').textContent = cNew;
                if (document.getElementById('count-cooking')) document.getElementById('count-cooking').textContent = cCook;
                if (document.getElementById('count-ready')) document.getElementById('count-ready').textContent = cReady;

            } catch (err) { console.error("Failed to fetch orders", err); }
        }

        async function updateStatus(id, status) {
            try {
                await fetch(`/api/v1/orders/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                fetchOrders(); // Refresh
                fetchStats();
            } catch (err) { console.error(err); }
        }



        // Fetch Inventory
        async function fetchInventory() {
            try {
                const res = await fetch("/api/v1/inventory");
                const data = await res.json();
                const tbody = document.getElementById('inventory-body');
                if (!tbody) return;
                tbody.innerHTML = '';

                data.forEach(item => {
                    const row = document.createElement('tr');
                    const lowStock = item.quantity <= item.lowStockThreshold;
                    const itemName = item.menuId ? item.menuId.name : (item.tempName || 'Unknown Item');
                    const menuId = item.menuId ? (item.menuId._id || item.menuId.id) : null;

                    if (!menuId) return; // Skip invalid items

                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium text-white">${itemName}</td>
                        <td class="px-6 py-4">
                            <input type="number" value="${item.quantity}" 
                                onchange="updateStock('${item.menuId._id}', this.value)"
                                class="bg-black/20 border ${lowStock ? 'border-red-500 text-red-500' : 'border-white/10 text-white'} rounded px-2 py-1 w-20 text-center focus:outline-none focus:border-primary">
                        </td>
                        <td class="px-6 py-4">
                            ${lowStock ? '<span class="text-xs bg-red-500/10 text-red-500 px-2 py-1 rounded border border-red-500/20">Low Stock</span>' : '<span class="text-xs bg-green-500/10 text-green-500 px-2 py-1 rounded border border-green-500/20">In Stock</span>'}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button class="text-xs text-gray-400 hover:text-white underline">History</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) { console.error("Failed to fetch inventory", err); }
        }

        async function updateStock(menuId, qty) {
            try {
                await fetch(`/api/v1/inventory/${menuId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantity: qty })
                });
                fetchInventory(); // Refresh to update status
            } catch (e) { alert("Failed to update stock"); }
        }
        // Fetch Menu
        let currentContextMenuData = [];

        async function fetchMenu() {
            try {
                const res = await fetch("/api/v1/menu");
                const menu = await res.json();
                currentContextMenuData = menu;
                const grid = document.getElementById("menu-grid");
                if (grid) {
                    grid.innerHTML = '';
                    menu.forEach(item => {
                        const isPending = item.status === 'pending';
                        // Image Handling - Robust Check
                        let imageHtml = `<div class="w-full h-full bg-gray-700 flex items-center justify-center text-gray-400 font-bold text-xl">${item.name[0]}</div>`;
                        const imgUrl = item.imageUrl || item.image_url; // Handle both camelCase and snake_case
                        if (imgUrl && (imgUrl.startsWith('data:image') || imgUrl.startsWith('http'))) {
                            imageHtml = `<img src="${imgUrl}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">`;
                        }

                        const itemId = item._id || item.id;
                        grid.innerHTML += `
                        <div class="glass-panel rounded-xl overflow-hidden group ${isPending ? 'border border-yellow-500/50' : ''} relative">
                            ${isPending ? '<div class="absolute top-2 left-2 z-10 bg-yellow-500 text-black text-[10px] font-bold px-2 py-0.5 rounded">PENDING APPROVAL</div>' : ''}
                            <div class="h-40 bg-gray-800 relative overflow-hidden">
                                ${imageHtml}
                                <div class="absolute top-2 right-2 bg-black/60 backdrop-blur px-2 py-1 rounded text-xs text-white font-bold">₹${item.price}</div>
                            </div>
                            <div class="p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-bold text-white text-md">${item.name}</h3>
                                    ${!isPending ? `
                                    <div class="relative inline-block w-8 h-4 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" onchange="toggleAvailability('${itemId}', this.checked)" ${item.available ? 'checked' : ''} class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer ${item.available ? 'bg-primary right-0' : 'bg-gray-500 right-4'}"/>
                                    </div>` : ''}
                                </div>
                                <p class="text-xs text-gray-500 line-clamp-2 mb-4">${item.category}</p>
                                <div class="flex gap-2">
                                    <button onclick="editMenu('${itemId}')" class="flex-1 border border-white/10 py-1.5 rounded hover:bg-white/5 text-xs text-gray-300" ${isPending ? 'disabled' : ''}>Edit</button>
                                    <button onclick="deleteMenu('${itemId}')" class="flex-1 border border-red-500/30 py-1.5 rounded hover:bg-red-500/10 text-xs text-red-500">Delete</button>
                                </div>
                            </div>
                        </div>`;
                    });
                }
            } catch (err) { console.error("Failed to fetch menu", err); }
        }

        async function toggleAvailability(id, isActive) {
            try {
                const res = await fetch(`/api/v1/menu/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ available: isActive })
                });

                if (res.ok) {
                    fetchMenu(); // Re-render to update UI state reliably
                } else {
                    showAlert("Failed to update status");
                    fetchMenu(); // Revert UI
                }
            } catch (e) {
                console.error(e);
                showAlert("Error updating status");
            }
        }

        async function deleteMenu(id) {
            console.log("Attempting to delete menu item:", id);
            if (!id || id === 'undefined') {
                return showAlert("Error: Invalid Menu ID");
            }
            if (!await showConfirm("Are you sure you want to delete this menu item?")) return;

            try {
                const res = await fetch(`/api/v1/menu/${id}`, { method: 'DELETE' });
                const data = await res.json();

                if (res.ok) {
                    console.log("Delete success:", data);
                    await showAlert("Menu item deleted successfully.");
                    fetchMenu();
                } else {
                    console.error("Delete failed:", data);
                    showAlert(`Failed to delete: ${data.message || 'Unknown error'}`);
                }
            } catch (e) {
                console.error("Delete exception:", e);
                showAlert("Network error while deleting item.");
            }
        }

        // Fetch History
        async function fetchHistory() {
            const dateFrom = document.getElementById('hist-date-from').value;
            const dateTo = document.getElementById('hist-date-to').value;
            const status = document.getElementById('hist-status').value;

            const params = new URLSearchParams();
            if (dateFrom) params.append('dateFrom', dateFrom);
            if (dateTo) params.append('dateTo', dateTo);
            if (status) params.append('status', status);

            try {
                const res = await fetch(`/api/v1/orders?${params.toString()}`);
                const orders = await res.json();
                const tbody = document.getElementById('history-body');
                tbody.innerHTML = '';

                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center">No orders found</td></tr>';
                    return;
                }

                orders.forEach(order => {
                    const row = document.createElement('tr');
                    // XSS Protection for items and tableNo
                    const items = order.items.map(i => `${escapeHtml(i.qty)}x ${escapeHtml(i.name)}`).join(', ');
                    row.innerHTML = `
                        <td class="px-6 py-4">${new Date(order.createdAt).toLocaleDateString()} ${new Date(order.createdAt).toLocaleTimeString()}</td>
                        <td class="px-6 py-4 font-mono text-white">#${escapeHtml(order.id.slice(-6))}</td>
                        <td class="px-6 py-4"><span class="bg-white/10 px-2 py-1 rounded text-xs">${escapeHtml(order.tableNo)}</span></td>
                        <td class="px-6 py-4 text-white line-clamp-1" title="${items}">${items}</td>
                        <td class="px-6 py-4 font-bold text-primary">₹${escapeHtml(order.total)}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs border border-white/20 ${order.status === 'Paid' ? 'text-green-500 bg-green-500/10' : 'text-gray-300'}">${escapeHtml(order.status)}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (e) { console.error("History fetch failed", e); }
        }

        async function fetchKDS() {
            try {
                // Fetch active orders (New, Cooking)
                // In prod, use a dedicated endpoint or filter existing orders
                const res = await fetch("/api/v1/orders?status=active"); // Backend needs to support 'active' alias or multiple statuses
                // For MVP, fetch all and filter client side or use existing order fetch
                const allRes = await fetch("/api/v1/orders"); // Getting all for now
                const orders = await allRes.json();

                const kdsGrid = document.getElementById('kds-grid');
                if (!kdsGrid) return;
                kdsGrid.innerHTML = '';

                // Filter for KDS states
                const activeOrders = orders.filter(o => ['New', 'Cooking'].includes(o.status)).sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)); // FIFO

                activeOrders.forEach(order => {
                    const elapsed = Math.floor((new Date() - new Date(order.createdAt)) / 60000);
                    let timerColor = 'text-gray-400';
                    if (elapsed > 15) timerColor = 'text-red-500 animate-pulse';
                    else if (elapsed > 10) timerColor = 'text-yellow-500';

                    // Items list
                    const itemsHtml = order.items.map(i => `
                        <div class="flex justify-between items-center border-b border-white/10 py-2">
                             <span class="font-bold text-lg text-white">${i.quantity || i.qty || 1}x ${i.name}</span>
                        </div>
                    `).join('');

                    const ticket = document.createElement('div');
                    ticket.className = `bg-gray-800 rounded-xl p-4 border-l-4 ${order.status === 'New' ? 'border-blue-500' : 'border-orange-500'} flex flex-col h-full justify-between`;

                    // Robust table/id
                    const tableNum = order.tableNo || order.table_no || '?';
                    const oId = order.id || order._id;

                    ticket.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <span class="block text-2xl font-bold text-white">Table ${tableNum}</span>
                                    <span class="text-xs text-gray-400">#${oId.toString().slice(-4)}</span>
                                </div>
                                <div class="text-right">
                                    <span class="block text-xl font-mono font-bold ${timerColor}">${elapsed}m</span>
                                </div>
                            </div>
                            <div class="mb-4">
                                ${itemsHtml}
                            </div>
                        </div>
                        <div class="mt-4">
                            ${order.status === 'New'
                            ? `<button onclick="updateStatus('${oId}', 'Cooking')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded text-xl">START COOKING</button>`
                            : `<button onclick="updateStatus('${oId}', 'Ready')" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 rounded text-xl">MARK READY</button>`
                        }
                        </div>
                    `;
                    kdsGrid.appendChild(ticket);
                });

            } catch (e) { console.error("KDS Fetch Failed", e); }
        }

        // Poll KDS if active
        setInterval(() => {
            const kdsView = document.getElementById('view-kds');
            if (kdsView && !kdsView.classList.contains('hidden')) {
                fetchKDS();
            }
        }, 5000);

        // Fetch Reservations
        async function fetchReservations() {
            try {
                const res = await fetch("/api/v1/reservations");
                const reservations = await res.json();
                const tbody = document.getElementById('reservations-body');
                if (!tbody) return;
                tbody.innerHTML = '';

                reservations.forEach(res => {
                    const row = document.createElement('tr');
                    let statusColor = 'text-gray-300';
                    if (res.status === 'Confirmed') statusColor = 'text-green-500';
                    if (res.status === 'Cancelled') statusColor = 'text-red-500';

                    row.innerHTML = `
                        <td class="px-6 py-4 text-white">${new Date(res.time).toLocaleString()}</td>
                        <td class="px-6 py-4 font-bold text-white">${res.customerName}</td>
                        <td class="px-6 py-4">${res.guests} ppl</td>
                        <td class="px-6 py-4"><span class="bg-white/10 px-2 py-1 rounded text-xs">${res.tableNo}</span></td>
                        <td class="px-6 py-4">${res.contactNumber || '-'}</td>
                        <td class="px-6 py-4"><span class="${statusColor}">${res.status}</span></td>
                        <td class="px-6 py-4 text-right">
                            ${res.status === 'Pending' ?
                            `<button onclick="updateResStatus('${res._id}', 'Confirmed')" class="text-green-500 hover:underline mr-2">Confirm</button>
                                 <button onclick="updateResStatus('${res._id}', 'Cancelled')" class="text-red-500 hover:underline">Cancel</button>`
                            : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (e) { console.error("Reservations fetch failed", e); }
        }

        async function updateResStatus(id, status) {
            try {
                await fetch(`/api/v1/reservations/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                fetchReservations();
            } catch (e) { alert("Failed to update reservation"); }
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('generic-modal');
                const titleEl = document.getElementById('modal-title');
                const bodyEl = document.getElementById('modal-body');
                const submitBtn = document.getElementById('modal-submit-btn');
                const backdrop = document.getElementById('modal-backdrop');
                const panel = document.getElementById('modal-panel');

                // Reset modal appearance for Confirm
                titleEl.textContent = "Confirm Action";
                bodyEl.innerHTML = `<div class="py-4 text-center"><p class="text-gray-300">${message}</p></div>`;
                submitBtn.textContent = "Confirm";

                // Show modal
                modal.classList.remove('hidden');
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    panel.classList.remove('opacity-0', 'scale-95');
                }, 10);

                // Bind submit
                submitBtn.onclick = () => closeModal(true);
                currentModalResolve = resolve;
            });
        }

        function showAlert(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('generic-modal');
                const titleEl = document.getElementById('modal-title');
                const bodyEl = document.getElementById('modal-body');
                const submitBtn = document.getElementById('modal-submit-btn');
                const backdrop = document.getElementById('modal-backdrop');
                const panel = document.getElementById('modal-panel');

                // Reset modal appearance for Alert
                titleEl.textContent = "Notification";
                bodyEl.innerHTML = `<div class="py-4 text-center"><p class="text-gray-300">${message}</p></div>`;
                submitBtn.textContent = "Understood";

                // Show modal
                modal.classList.remove('hidden');
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    panel.classList.remove('opacity-0', 'scale-95');
                }, 10);

                // Re-bind submit to just close
                submitBtn.onclick = () => closeModal(true);
                currentModalResolve = resolve;
            });
        }

        // --- MODAL SYSTEM ---
        let currentModalResolve = null;

        function openModal({ title, fields, submitLabel = 'Create' }) {
            return new Promise((resolve) => {
                const modal = document.getElementById('generic-modal');
                const backdrop = document.getElementById('modal-backdrop');
                const panel = document.getElementById('modal-panel');
                const titleEl = document.getElementById('modal-title');
                const bodyEl = document.getElementById('modal-body');
                const submitBtn = document.getElementById('modal-submit-btn');

                // Set Content
                titleEl.textContent = title;
                submitBtn.textContent = submitLabel;
                bodyEl.innerHTML = '';

                // Generate Fields
                fields.forEach(field => {
                    const div = document.createElement('div');
                    // CHECK FOR DEFAULT VALUE
                    const valueAttr = field.defaultValue ? `value="${field.defaultValue}"` : '';

                    div.innerHTML = `
                <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1 font-semibold">${field.label}</label>
                ${field.type === 'select' ?
                            `<select name="${field.name}" class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-primary transition-colors">
                        ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>` :
                            `<input type="${field.type}" name="${field.name}" placeholder="${field.placeholder || ''}" ${valueAttr}
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-primary transition-colors placeholder-gray-600">`
                        }
            `;
                    bodyEl.appendChild(div);
                });

                // Show Modal (Animation)
                modal.classList.remove('hidden');
                // Trigger reflow
                void modal.offsetWidth;
                backdrop.classList.remove('opacity-0');
                panel.classList.remove('opacity-0', 'scale-95');

                // Handle Submit Logic
                const handleSubmit = () => {
                    const formData = {};
                    const inputs = bodyEl.querySelectorAll('input, select');
                    let valid = true;
                    inputs.forEach(input => {
                        // Allow empty if not required (custom logic if needed, but for now strict)
                        if (!input.value) valid = false;
                        formData[input.name] = input.value;
                    });

                    if (valid) {
                        closeModal(formData);
                    } else {
                        // Shake animation for error
                        panel.classList.add('animate-pulse');
                        setTimeout(() => panel.classList.remove('animate-pulse'), 500);
                    }
                };

                submitBtn.onclick = handleSubmit;

                // Handle Enter Key on Inputs
                const inputs = bodyEl.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleSubmit();
                        }
                    });
                });

                // Focus first input
                if (inputs.length > 0) inputs[0].focus();

                currentModalResolve = resolve;
            });
        }

        function closeModal(result = null) {
            const modal = document.getElementById('generic-modal');
            const backdrop = document.getElementById('modal-backdrop');
            const panel = document.getElementById('modal-panel');

            backdrop.classList.add('opacity-0');
            panel.classList.add('opacity-0', 'scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
                if (currentModalResolve) {
                    currentModalResolve(result);
                    currentModalResolve = null;
                }
            }, 300);
        }

        // Add Menu (Replaced Alert)
        async function promptAddMenu() {
            const data = await openModal({
                title: 'Add New Menu Item',
                fields: [
                    { name: 'name', label: 'Item Name (EN)', type: 'text', placeholder: 'e.g. Truffle Pizza' },
                    { name: 'name_hi', label: 'Item Name (HI)', type: 'text', placeholder: 'e.g. ट्रफल पिज़्ज़ा' },
                    { name: 'category', label: 'Category', type: 'select', options: ['Main', 'Starter', 'Dessert', 'Drink'] },
                    { name: 'price', label: 'Price (₹)', type: 'number', placeholder: 'e.g. 450' },
                    { name: 'desc_en', label: 'Desc (EN)', type: 'text', placeholder: 'Description in English' },
                    { name: 'desc_hi', label: 'Desc (HI)', type: 'text', placeholder: 'Description in Hindi' }
                ],
                submitLabel: 'Submit Request'
            });

            if (!data) return;

            const price = parseFloat(data.price) || 0;
            if (price <= 0) return showAlert("Invalid Price");

            try {
                const res = await fetch("/api/v1/menu", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: data.name,
                        name_hi: data.name_hi,
                        description_en: data.desc_en,
                        description_hi: data.desc_hi,
                        category: data.category || 'Main',
                        price: price,
                        image_url: ""
                    })
                });
                const resData = await res.json();
                if (resData.success) {
                    showAlert("Item submitted for approval! It will appear once approved by Admin.");
                    fetchMenu();
                } else {
                    showAlert("Failed to add item");
                }
            } catch (e) {
                console.error(e);
                showAlert("Error adding item");
            }
        }

        async function editMenu(itemId) {
            const item = currentContextMenuData.find(i => i.id === itemId);
            if (!item) return showAlert("Error: Item not found");

            const data = await openModal({
                title: 'Edit Menu Item',
                fields: [
                    { name: 'name', label: 'Item Name', type: 'text', defaultValue: item.name },
                    { name: 'price', label: 'Price (₹)', type: 'number', defaultValue: item.price },
                    { name: 'category', label: 'Category', type: 'select', options: ['Main', 'Starter', 'Dessert', 'Drink'], defaultValue: item.category }
                ],
                submitLabel: 'Save Changes'
            });

            if (!data) return;

            try {
                const res = await fetch(`/api/v1/menu/${item.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: data.name,
                        price: parseFloat(data.price),
                        category: data.category
                    })
                });

                if (res.ok) {
                    fetchMenu();
                    showAlert("Item updated successfully");
                } else {
                    showAlert("Update failed");
                }
            } catch (e) { console.error(e); showAlert("Error updating item"); }
        }

        function printInvoice(orderId) {
            const printWindow = window.open('', '_blank', 'width=400,height=600');
            printWindow.document.write(`<html><head><title>Print Receipt</title></head><body style="font-family: monospace; padding: 20px;">
                <h3 style="text-align:center">Tap2Serve</h3>
                <p style="text-align:center">Order #${orderId.slice(-4)}</p>
                <hr/>
                <p>Date: ${new Date().toLocaleString()}</p>
                <p>This is a customer copy.</p>
                <hr/>
                <script>window.print();<\/script>
</body>

</html>`);
            printWindow.document.close();
        }

        async function exportTransactions() {
            try {
                const res = await fetch("/api/v1/orders");
                const data = await res.json();
                const paid = data.filter(o => o.status === 'Served' || o.status === 'Paid');

                if (paid.length === 0) return showAlert("No transactions to export");

                const headers = ['Order ID', 'Date', 'Table', 'Items', 'Total', 'Status'];
                const rows = paid.map(o => [
                    o.id,
                    new Date(o.createdAt).toISOString(),
                    o.table_no,
                    o.items.map(i => `${i.quantity}x ${i.name}`).join(';'),
                    o.total,
                    o.status
                ]);

                const csvContent = [headers.join(',')].concat(rows.map(r => r.join(','))).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `transactions_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            } catch (e) { console.error(e); showAlert("Export failed"); }
        }
        // Fetch Reports (Sales Chart)
        // Fetch Reports (Sales Chart)
        async function fetchReports() {
            try {
                const res = await fetch("/api/v1/stats/reports");
                const data = await res.json();

                // Adapter: Backend returns { trends: [ {_id: 'YYYY-MM-DD', dailyRevenue: N} ], statusDistribution: [] }
                let weeklyData = [];
                if (data.trends && Array.isArray(data.trends)) {
                    // Sort by date just in case
                    data.trends.sort((a, b) => new Date(a._id) - new Date(b._id));
                    // Take last 7
                    const recent = data.trends.slice(-7);
                    weeklyData = recent.map(t => {
                        const date = new Date(t._id);
                        return {
                            day: date.toLocaleDateString('en-US', { weekday: 'short' }),
                            total: t.dailyRevenue || 0
                        };
                    });
                } else if (data.weekly) {
                    weeklyData = data.weekly; // Fallback to mock format if changed
                }

                // Update Reports View Chart
                const reportsChart = document.getElementById("weekly-sales-chart");
                const dashboardChart = document.getElementById("revenue-chart-container");

                if (weeklyData.length > 0) {
                    const maxVal = Math.max(...weeklyData.map(d => d.total)) || 1000;
                    const chartHtml = weeklyData.map(day => `
<div class="w-full bg-primary rounded-t relative group transition-all duration-500 hover:opacity-100 opacity-80"
    style="height: ${Math.max((day.total / maxVal) * 100, 5)}%">
    <div
        class="absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
        ₹${day.total}</div>
</div>
`).join('');

                    if (reportsChart) reportsChart.innerHTML = chartHtml;
                    if (dashboardChart) dashboardChart.innerHTML = chartHtml;

                    // Update Labels
                    const labelsContainer = document.querySelector("#view-reports .flex.justify-between.text-xs");
                    if (labelsContainer) {
                        labelsContainer.innerHTML = weeklyData.map(d => `<span>${d.day}</span>`).join('');
                    }
                    // Update Dashboard Labels
                    const dashLabels = document.querySelector("#view-dashboard .text-xs.uppercase");
                    if (dashLabels) {
                        dashLabels.innerHTML = weeklyData.map(d => `<span>${d.day}</span>`).join('');
                    }

                } else {
                    const emptyHtml = `<div class="w-full h-full flex items-center justify-center text-gray-600 text-xs">No data available</div>`;
                    if (reportsChart) reportsChart.innerHTML = emptyHtml;
                    if (dashboardChart) dashboardChart.innerHTML = emptyHtml;
                }

                // Update Order Sources (Status Distribution)
                const sourcesChart = document.getElementById("order-sources-chart");
                if (sourcesChart && data.statusDistribution) {
                    const total = data.statusDistribution.reduce((acc, curr) => acc + curr.count, 0);
                    if (total > 0) {
                        sourcesChart.innerHTML = data.statusDistribution.map(s => {
                            const pct = Math.round((s.count / total) * 100);
                            return `<div class="w-full mb-3">
                                       <div class="flex justify-between text-xs text-gray-400 mb-1">
                                          <span>${s._id}</span>
                                          <span>${pct}% (${s.count})</span>
                                       </div>
                                       <div class="w-full bg-white/10 rounded-full h-2">
                                          <div class="bg-primary h-2 rounded-full" style="width: ${pct}%"></div>
                                       </div>
                                     </div>`;
                        }).join('');
                        sourcesChart.classList.remove("items-center", "justify-center");
                        sourcesChart.classList.add("flex-col", "justify-start", "pt-4", "px-4", "overflow-y-auto");
                    }
                }

            } catch (e) { console.error("Reports error", e); }
        }

        // Fetch Transactions
        // Fetch Transactions
        async function fetchTransactions() {
            try {
                const dateFrom = document.getElementById('txn-date-from') ? document.getElementById('txn-date-from').value : '';
                const dateTo = document.getElementById('txn-date-to') ? document.getElementById('txn-date-to').value : '';

                // API Call (Generic fetch all for now, filter client side for MVP)
                const res = await fetch("/api/v1/orders");
                const allOrders = await res.json();

                // Filter Status
                let data = allOrders.filter(o => o.status === 'Served' || o.status === 'Paid');

                // Filter Dates
                if (dateFrom) {
                    const start = new Date(dateFrom);
                    data = data.filter(o => new Date(o.createdAt) >= start);
                }
                if (dateTo) {
                    const end = new Date(dateTo);
                    end.setHours(23, 59, 59);
                    data = data.filter(o => new Date(o.createdAt) <= end);
                }

                // Sort Descending 
                data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                const tbody = document.querySelector("#view-transactions tbody");
                if (tbody) {
                    if (data.length === 0) {
                        tbody.innerHTML = `<tr>
        <td colspan="6" class="p-6 text-center text-gray-600">No transactions found</td>
    </tr>`;
                    } else {
                        tbody.innerHTML = data.map(txn => `
    <tr class="hover:bg-white/5 transition-colors">
        <td class="px-6 py-4 text-white font-mono">
            #TXN-${txn.id ? txn.id.slice(-4) : '???'}
            <div class="text-[10px] text-gray-500">${txn.invoiceId || ''}</div>
        </td>
        <td class="px-6 py-4">${new Date(txn.createdAt).toLocaleString()}</td>
        <td class="px-6 py-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">payments</span> Cash
        </td>
        <td class="px-6 py-4">
            <span
                class="text-green-500 text-xs border border-green-500/30 bg-green-500/10 px-2 py-0.5 rounded">${txn.status}</span>
        </td>
        <td class="px-6 py-4 text-right text-white">₹${txn.total}</td>
        <td class="px-6 py-4 text-right">
            <button onclick="printInvoice('${txn.id}')" class="bg-white/10 hover:bg-white/20 p-2 rounded text-white"
                title="Print Bill">
                <span class="material-symbols-outlined text-sm">print</span>
            </button>
        </td>
    </tr>
    `).join('');
                    }
                }
            } catch (e) { console.error("Txn error", e); }
        }

        // Waiter Calls
        async function fetchWaiterCalls() {
            try {
                const res = await fetch("/api/v1/waiter"); // Staff endpoint
                const calls = await res.json();
                const panel = document.getElementById('waiter-alert-panel');
                const list = document.getElementById('waiter-alert-list');

                if (!panel || !list) return;

                if (calls.length > 0) {
                    panel.classList.remove('hidden');
                    list.innerHTML = calls.map(call => `
    <div class="bg-red-500 text-white text-xs p-2 rounded flex justify-between items-center">
        <span>Table ${call.tableNo} (${call.type})</span>
        <button onclick="resolveCall('${call._id}')"
            class="bg-white/20 px-2 py-0.5 rounded hover:bg-white/40">✓</button>
    </div>
    `).join('');
                } else {
                    panel.classList.add('hidden');
                }
            } catch (e) { console.error("Waiter fetch failed", e); }
        }

        async function resolveCall(id) {
            try {
                await fetch(`/api/v1/waiter/${id}/resolve`, { method: 'PUT' });
                fetchWaiterCalls();
            } catch (e) { }
        }

        // Poll for waiter calls
        setInterval(fetchWaiterCalls, 10000);



        // Analytics Stats

        async function handleTableClick(tableId) {
            try {
                // 1. Check if occupied
                const res = await fetch("/api/v1/orders");
                const orders = await res.json();
                const activeOrder = orders.find(o => o.table_no === tableId && ['New', 'Cooking', 'Ready'].includes(o.status));

                if (activeOrder) {
                    showAlert(`Table ${tableId} is OCCUPIED.\n\nOrder #${activeOrder.id}\nStatus: ${activeOrder.status}\nTotal:
    ₹${activeOrder.total}`);
                } else {
                    // 2. New Order Flow
                    // Fetch Menu for Select dropdown
                    const menuRes = await fetch("/api/v1/menu");
                    const menuData = await menuRes.json();

                    // Filter out PENDING items - Owner cannot take order until approved
                    const availableItems = menuData.filter(m => m.status !== 'pending');

                    // Create formatted options: "Item Name | ₹Price"
                    const menuOptions = availableItems.map(m => `${m.name} | ₹${m.price}`);

                    if (menuOptions.length === 0) {
                        return showAlert("No approved menu items available. Please wait for Admin approval.");
                    }

                    const data = await openModal({
                        title: `New Order for ${tableId}`,
                        fields: [
                            { name: 'itemStr', label: 'Select Item', type: 'select', options: menuOptions },
                            { name: 'qty', label: 'Quantity', type: 'number', placeholder: '1', defaultValue: '1' }
                        ],
                        submitLabel: 'Place Order'
                    });

                    if (!data) return;

                    // Parse selection
                    // "Item Name | ₹Price" -> split
                    const [namePart, pricePart] = data.itemStr.split(' | ₹');
                    const itemName = namePart.trim();
                    const itemPrice = parseFloat(pricePart);
                    const qty = parseInt(data.qty) || 1;

                    // Lookup menuId for Inventory Logic
                    const selectedMenu = availableItems.find(m => m.name === itemName);
                    const menuId = selectedMenu ? selectedMenu._id : null;

                    const total = itemPrice * qty;
                    const idempotencyKey = 'dash_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                    await fetch("/api/v1/orders", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            table_no: tableId,
                            status: 'New', // EXPLICITLY SET STATUS TO 'NEW'
                            items: [{
                                name: itemName,
                                quantity: qty, // Consistency: Schema mostly uses 'quantity' or 'qty'
                                price: itemPrice,
                                menuId: menuId
                            }],
                            total: total,
                            restaurantId: currentRestaurant ? currentRestaurant.id : undefined, // Ensure restaurant binding
                            idempotencyKey: idempotencyKey
                        })
                    });

                    // Show confirmation?
                    // alert("Order Placed!"); // Optional, maybe too noisy
                    fetchOrders();
                    fetchTables();
                    fetchStats();
                    fetchRecentOrders();
                }
            } catch (e) {
                console.error(e);
                showAlert("Error handling table interaction");
            }
        }



        let currentRestaurant = null;

        async function fetchRestaurantDetails() {
            try {
                const res = await fetch("/api/v1/restaurants");
                const data = await res.json();
                if (data.length > 0) {
                    currentRestaurant = data[0]; // Assuming single restaurant context for manager
                    // Save for QR generation
                    console.log("Loaded Restaurant:", currentRestaurant.name);
                }
            } catch (e) { console.error("Failed to load restaurant details", e); }
        }

        // Fetch & Update Tables Status
        async function fetchTables() {
            if (!currentRestaurant) await fetchRestaurantDetails();
            if (!currentRestaurant) return;

            try {
                const res = await fetch("/api/v1/orders");
                const orders = await res.json();
                const activeTables = new Set(orders.filter(o => ['New', 'Cooking', 'Ready'].includes(o.status)).map(o =>
                    o.table_no));

                const grid = document.getElementById('tables-grid');
                if (!grid) return;

                const count = currentRestaurant.tableCount || 10;
                const input = document.getElementById('table-count-input');
                if (input && !input.value) input.value = count;

                const hostInput = document.getElementById('qr-host');
                if (hostInput && !hostInput.value) hostInput.value = window.location.host;

                let html = '';
                for (let i = 1; i <= count; i++) {
                    const tableId = `T-${i.toString().padStart(2, '0')}`; const
                        isOccupied = activeTables.has(tableId); const
                            qrUrl = `menu.html?restaurantId=${currentRestaurant.id}&table=${tableId}`; html += ` <div class="relative group">
        <div onclick="handleTableClick('${tableId}')"
            class="aspect-square border-2 rounded-2xl flex flex-col items-center justify-center relative cursor-pointer transition-colors
                                        ${isOccupied ? 'bg-red-500/10 border-red-500 hover:bg-red-500/20' : 'bg-green-500/10 border-green-500 hover:bg-green-500/20'}">
            <span class="text-2xl font-bold ${isOccupied ? 'text-red-500' : 'text-green-500'}">${tableId}</span>
            <span class="text-xs mt-1 ${isOccupied ? 'text-red-400' : 'text-green-400'}">${isOccupied ? 'Occupied' :
                                    'Empty'}</span>
        </div>

        <!-- QR Hover -->
        <div
            class="absolute -bottom-10 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity z-10">
            <a href="${qrUrl}" target="_blank"
                class="bg-white text-black text-[10px] font-bold px-2 py-1 rounded shadow-lg whitespace-nowrap hover:bg-primary">
                Open QR Menu
            </a>
        </div>
        </div>
        `;
                }
                grid.innerHTML = html;

            } catch (e) { console.error("Tables error", e); }
        }

        async function updateTableCount() {
            const count = parseInt(document.getElementById('table-count-input').value);
            if (!count || count < 1) return showAlert("Invalid table count"); try {
                const res = await
                    fetch("/api/v1/restaurants/" + currentRestaurant.id, {
                        method: 'PUT', headers: {
                            'Content-Type'
                                : 'application/json'
                        }, body: JSON.stringify({ tableCount: count })
                    }); if (res.ok) {
                        currentRestaurant.tableCount = count; fetchTables(); showAlert("Table count updated successfully!");
                    } else {
                    showAlert("Failed to update settings");
                }
            } catch (e) {
                console.error(e);
                showAlert("Error saving settings");
            }
        }

        function updatePrepTime(val) {
            localStorage.setItem('kds_prep_time', val);
        }

        // Init Prep Time
        document.addEventListener("DOMContentLoaded", () => {
            const stored = localStorage.getItem('kds_prep_time');
            if (stored && document.getElementById('prep-time-input')) {
                document.getElementById('prep-time-input').value = stored;
            }
        });

        function printQRCodes() {
            if (!currentRestaurant) return;
            const totalTables = currentRestaurant.tableCount || 10;
            const startInput = document.getElementById('qr-start');
            const endInput = document.getElementById('qr-end');
            const hostInput = document.getElementById('qr-host');

            const host = hostInput && hostInput.value.trim() ? hostInput.value.trim() : window.location.host;
            const protocol = window.location.protocol;
            let start = parseInt(startInput.value) || 1;
            let end = parseInt(endInput.value) || totalTables;

            if (start < 1) start = 1; if (end > totalTables) end = totalTables;
            if (start > end) {
                return showAlert("Invalid Range: Start (" + start + ") cannot be greater than End (" + end + ")");
            }

            const printWindow = window.open("", "_blank");

            // Build HTML string first
            let qrHtml = "";
            for (let i = start; i <= end; i++) {
                const tableId = "T-" + i.toString().padStart(2, "0"); const
                    url = protocol + "//" + host + "/testing-page/menu.html?restaurantId=" + currentRestaurant.id
                        + "&table=" + tableId; const qrSrc = "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data="
                            + encodeURIComponent(url); qrHtml += ` <div class="qr-card">
                    <h2>${currentRestaurant.name}</h2>
                    <div class="qr-box">
                        <img src="${qrSrc}" />
                    </div>
                    <div class="table-label">Table ${tableId}</div>
                    <div class="scan-label">Scan to Order</div>
                    </div>`;
            }

            printWindow.document.write(`
                    <html>

                    <head>
                        <title>Print QR Codes - ${currentRestaurant.name}</title>
                        <style>
                            body {
                                font-family: sans-serif;
                                padding: 20px;
                            }

                            .grid {
                                display: grid;
                                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                                gap: 20px;
                            }

                            .qr-card {
                                border: 2px solid #000;
                                border-radius: 10px;
                                padding: 20px;
                                text-align: center;
                                page-break-inside: avoid;
                            }

                            h2 {
                                margin: 0 0 10px 0;
                                font-size: 16px;
                            }

                            .qr-box img {
                                width: 120px;
                                height: 120px;
                            }

                            .table-label {
                                font-size: 24px;
                                font-weight: bold;
                                margin: 10px 0;
                            }

                            .scan-label {
                                font-size: 12px;
                                color: #555;
                                text-transform: uppercase;
                                letter-spacing: 1px;
                            }

                            @media print {
                                button {
                                    display: none;
                                }
                            }
                        </style>
                    </head>

                    <body>
                        <button onclick="window.print()"
                            style="padding: 10px 20px; font-size: 16px; margin-bottom: 20px; cursor: pointer;">Print
                            Now</button>
                        <div class="grid">${qrHtml}</div>
                    </body>

                    </html>
                    `);
            printWindow.document.close();
        }

        document.addEventListener("DOMContentLoaded", async () => {
            // Load restaurant context first (critical for multi-tenant)
            await fetchRestaurantDetails();

            // Initial data load
            fetchStats();
            fetchOrders();
            fetchMenu();
            fetchInventory();
            fetchReservations();
            fetchReports();
            fetchTransactions();
            fetchTables();
            fetchRecentOrders();
            fetchWaiterCalls();

            // Auto-refresh every 3 seconds
            setInterval(() => {
                fetchOrders();
                fetchTables();
                fetchStats();
                fetchRecentOrders();
            }, 3000);

            // Slower refresh for heavy data
            setInterval(() => {
                fetchTransactions();
                fetchReports();
                fetchInventory();
            }, 10000);
        });
    </script>
</body>

</html>