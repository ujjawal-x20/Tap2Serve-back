<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Tap2Serve</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1"
        rel="stylesheet" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#c9a24d",
                        "primary-dark": "#a08036",
                        "bg-deep": "#050505",
                        "bg-soft": "#121212",
                        "bg-card": "#1a1a1a",
                        "text-main": "#ffffff",
                        "text-muted": "#b5b5b5",
                        "system-red": "#ff4d4d",
                        "system-green": "#4dff88",
                        "system-yellow": "#ffcc00",
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #050505;
            color: #fff;
        }

        .glass-panel {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sidebar-link {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            background: rgba(201, 162, 77, 0.05);
            color: #c9a24d;
            border-right: 3px solid #c9a24d;
        }

        .sidebar-link.active i {
            color: #c9a24d;
        }

        /* View transition */
        .view-section {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Toggles */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #c9a24d;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #c9a24d;
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden selection:bg-primary selection:text-black">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-bg-soft border-r border-white/5 flex flex-col hidden md:flex">
        <div class="h-20 flex items-center px-8 border-b border-white/5">
            <span class="material-symbols-outlined text-primary text-3xl mr-2">admin_panel_settings</span>
            <div>
                <h1 class="text-base font-bold tracking-tight text-white">Tap2Serve</h1>
                <p class="text-[10px] text-gray-500 uppercase tracking-widest">Super Admin</p>
            </div>
        </div>

        <nav class="flex-1 py-8 flex flex-col gap-1">
            <div class="px-4 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Platform</div>
            <a onclick="switchTab('overview')" id="nav-overview"
                class="sidebar-link active flex items-center gap-4 px-8 py-3 text-sm font-medium text-gray-300">
                <span class="material-symbols-outlined text-[20px]">grid_view</span>
                Overview
            </a>
            <a onclick="switchTab('restaurants')" id="nav-restaurants"
                class="sidebar-link flex items-center gap-4 px-8 py-3 text-sm font-medium text-gray-300">
                <span class="material-symbols-outlined text-[20px]">storefront</span>
                Restaurants
                <span class="ml-auto text-[10px] bg-white/10 text-white px-2 py-0.5 rounded-full">42</span>
            </a>
            <a onclick="switchTab('users')" id="nav-users"
                class="sidebar-link flex items-center gap-4 px-8 py-3 text-sm font-medium text-gray-300">
                <span class="material-symbols-outlined text-[20px]">group</span>
                User Accounts
            </a>

            <div class="px-4 mt-8 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">System</div>
            <a onclick="switchTab('health')" id="nav-health"
                class="sidebar-link flex items-center gap-4 px-8 py-3 text-sm font-medium text-gray-300">
                <span class="material-symbols-outlined text-[20px]">dns</span>
                Server Health
            </a>
            <a onclick="switchTab('audit')" id="nav-audit"
                class="sidebar-link block w-full text-left px-6 py-3 text-sm text-gray-400 hover:text-white hover:bg-white/5 transition-colors">
                <span class="inline-block w-6 text-center mr-2">üìã</span>
                Audit Logs
            </a>
            <a onclick="switchTab('requests')" id="nav-requests"
                class="sidebar-link block w-full text-left px-6 py-3 text-sm text-gray-400 hover:text-white hover:bg-white/5 transition-colors">
                <span class="inline-block w-6 text-center mr-2">üîî</span>
                Menu Requests
            </a>
            <a onclick="switchTab('config')" id="nav-config"
                class="sidebar-link block w-full text-left px-6 py-3 text-sm text-gray-400 hover:text-white hover:bg-white/5 transition-colors">
                <span class="inline-block w-6 text-center mr-2">‚öôÔ∏è</span>
                Global Config
            </a>
        </nav>

        <div class="p-4 border-t border-white/5">
            <a href="index.html"
                class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/5 transition-colors text-sm text-gray-400 hover:text-white">
                <span class="material-symbols-outlined">logout</span>
                Logout
            </a>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col min-w-0 overflow-hidden bg-bg-deep relative">

        <!-- HEADER -->
        <header
            class="h-20 border-b border-white/5 flex items-center justify-between px-8 bg-bg-deep/50 backdrop-blur-md z-10">
            <h2 id="page-title" class="text-xl font-semibold text-white">Platform Overview</h2>

            <div class="flex items-center gap-6">
                <!-- Status Indicators -->
                <div
                    class="flex items-center gap-4 text-xs font-medium bg-bg-soft px-4 py-2 rounded-full border border-white/5">
                    <span class="flex items-center gap-2 text-gray-400">
                        <span class="size-2 rounded-full bg-system-green animate-pulse"></span> Systems Operational
                    </span>
                    <span class="w-[1px] h-3 bg-white/10"></span>
                    <span class="text-gray-400">v2.4.0</span>
                </div>

                <div
                    class="size-10 rounded-full bg-gray-800 border border-white/10 flex items-center justify-center text-primary font-bold">
                    SA
                </div>
            </div>
        </header>

        <!-- DASHBOARD CONTENT -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">

            <!-- ================= VIEW: OVERVIEW ================= -->
            <div id="view-overview" class="view-section active">
                <!-- KEY METRICS -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <!-- Card 1 -->
                    <div class="glass-panel p-6 rounded-xl border border-white/5">
                        <div class="text-gray-400 text-xs font-semibold uppercase tracking-wider mb-2">Total MRR</div>
                        <div id="stat-mrr" class="text-3xl font-bold text-white">‚Çπ...</div>
                        <div class="text-xs text-system-green mt-2 flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">trending_up</span> +15.3% this month
                        </div>
                    </div>
                    <!-- Card 2 -->
                    <div class="glass-panel p-6 rounded-xl border border-white/5">
                        <div class="text-gray-400 text-xs font-semibold uppercase tracking-wider mb-2">Active
                            Restaurants</div>
                        <div id="stat-active-restaurants" class="text-3xl font-bold text-white">...</div>
                        <div class="text-xs text-gray-500 mt-2">
                            3 pending approval
                        </div>
                    </div>
                    <!-- Card 3 -->
                    <div class="glass-panel p-6 rounded-xl border border-white/5">
                        <div class="text-gray-400 text-xs font-semibold uppercase tracking-wider mb-2">Total Users</div>
                        <div id="stat-total-users" class="text-3xl font-bold text-white">...</div>
                        <div class="text-xs text-system-green mt-2 flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">trending_up</span> +8% last week
                        </div>
                    </div>
                    <!-- Card 4 -->
                    <div class="glass-panel p-6 rounded-xl border border-white/5">
                        <div class="text-gray-400 text-xs font-semibold uppercase tracking-wider mb-2">Server Health
                        </div>
                        <div id="stat-health" class="text-3xl font-bold text-system-green">...</div>
                        <div class="text-xs text-gray-500 mt-2">
                            Optimal performance
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- LEFT: Restaurant Management Preview -->
                    <div class="lg:col-span-2 glass-panel rounded-xl overflow-hidden border border-white/5">
                        <div class="p-6 border-b border-white/5 flex justify-between items-center">
                            <h3 class="font-bold text-white">Top Performing Restaurants</h3>
                            <a onclick="switchTab('restaurants')"
                                class="text-primary text-xs font-bold cursor-pointer hover:underline">View All</a>
                        </div>
                        <table class="w-full text-left">
                            <thead class="bg-white/5 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-6 py-4">Restaurant</th>
                                    <th class="px-6 py-4">Revenue</th>
                                    <th class="px-6 py-4">Status</th>
                                </tr>
                            </thead>
                            <tbody id="top-restaurants-body" class="divide-y divide-white/5 text-sm text-gray-300">
                                <!-- Dynamic Data -->
                            </tbody>
                        </table>
                    </div>

                    <!-- RIGHT: Alerts -->
                    <div class="glass-panel p-6 rounded-xl border border-white/5">
                        <h3 class="font-bold text-white mb-4">System Alerts</h3>
                        <div class="space-y-4">
                            <div class="flex gap-3 items-start">
                                <span class="material-symbols-outlined text-system-red text-sm mt-0.5">error</span>
                                <div>
                                    <div class="text-sm text-white font-medium">Payment Gateway Latency</div>
                                    <div class="text-xs text-gray-500">High latency detected on Razorpay API (240ms).
                                    </div>
                                    <div class="text-[10px] text-gray-600 mt-1">2 mins ago</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= VIEW: RESTAURANTS ================= -->
            <div id="view-restaurants" class="view-section">
                <div class="glass-panel rounded-xl overflow-hidden border border-white/5">
                    <div class="p-6 border-b border-white/5 flex justify-between items-center">
                        <h3 class="font-bold text-white">Restaurant Management</h3>
                        <div class="flex gap-2">
                            <select
                                class="bg-bg-soft border border-white/10 rounded px-3 py-1.5 text-xs text-white focus:outline-none focus:border-primary">
                                <option>Status: All</option>
                                <option>Active</option>
                                <option>Suspended</option>
                                <option>Pending</option>
                            </select>
                            <input type="text" placeholder="Search..."
                                class="bg-bg-soft border border-white/10 rounded px-3 py-1.5 text-xs text-white focus:outline-none focus:border-primary">
                            <button onclick="createRestaurant()"
                                class="bg-primary text-black text-xs font-bold px-3 py-1.5 rounded hover:bg-white transition-colors">Add
                                New</button>
                        </div>
                    </div>
                    <table class="w-full text-left">
                        <thead class="bg-white/5 text-gray-400 text-xs uppercase">
                            <tr>
                                <th class="px-6 py-4">Restaurant</th>
                                <th class="px-6 py-4">Location</th>
                                <th class="px-6 py-4">Plan</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4">Revenue</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="restaurants-table-body" class="divide-y divide-white/5 text-sm text-gray-300">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ================= VIEW: USER ACCOUNTS ================= -->
            <div id="view-users" class="view-section">

                <!-- PENDING USERS SECTION -->
                <div id="pending-users-panel"
                    class="glass-panel rounded-xl overflow-hidden border border-white/5 mb-8 hidden">
                    <div class="p-6 border-b border-white/5 flex justify-between items-center bg-yellow-500/5">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-yellow-500">warning</span>
                            <h3 class="font-bold text-white">Pending User Requests</h3>
                        </div>
                    </div>
                    <table class="w-full text-left">
                        <thead class="bg-white/5 text-gray-400 text-xs uppercase">
                            <tr>
                                <th class="px-6 py-4">User</th>
                                <th class="px-6 py-4">Role</th>
                                <th class="px-6 py-4">Requested At</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-pending-table-body" class="divide-y divide-white/5 text-sm text-gray-300">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>

                <!-- ALL USERS SECTION -->
                <div class="glass-panel rounded-xl overflow-hidden border border-white/5">
                    <div class="p-6 border-b border-white/5 flex justify-between items-center">
                        <h3 class="font-bold text-white">Active User Accounts</h3>
                        <button onclick="createUser()"
                            class="bg-primary text-black text-xs font-bold px-3 py-1.5 rounded hover:bg-white transition-colors">Add
                            User</button>
                    </div>
                    <table class="w-full text-left">
                        <thead class="bg-white/5 text-gray-400 text-xs uppercase">
                            <tr>
                                <th class="px-6 py-4">User</th>
                                <th class="px-6 py-4">Role</th>
                                <th class="px-6 py-4">Last Login</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-active-table-body" class="divide-y divide-white/5 text-sm text-gray-300">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ================= VIEW: SERVER HEALTH ================= -->
            <div id="view-health" class="view-section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-8">
                    <!-- CPU -->
                    <div
                        class="glass-panel p-6 rounded-xl border border-white/5 flex flex-col items-center justify-center relative overflow-hidden">
                        <span class="material-symbols-outlined text-4xl text-primary mb-2">memory</span>
                        <h3 id="health-cpu-count" class="text-white text-3xl font-bold">--</h3>
                        <p id="health-cpu-model"
                            class="text-gray-400 text-xs uppercase tracking-widest mt-1 text-center px-2 truncate w-full">
                            CPU Model</p>
                    </div>
                    <!-- OS -->
                    <div
                        class="glass-panel p-6 rounded-xl border border-white/5 flex flex-col items-center justify-center relative overflow-hidden">
                        <span class="material-symbols-outlined text-4xl text-purple-400 mb-2">terminal</span>
                        <h3 id="health-os" class="text-white text-xl font-bold text-center">--</h3>
                        <p class="text-gray-400 text-xs uppercase tracking-widest mt-1">Operating System</p>
                    </div>
                    <!-- RAM -->
                    <div
                        class="glass-panel p-6 rounded-xl border border-white/5 flex flex-col items-center justify-center relative overflow-hidden">
                        <div class="absolute inset-0 bg-system-yellow/5"></div>
                        <span class="material-symbols-outlined text-4xl text-system-yellow mb-2">storage</span>
                        <h3 id="health-ram-usage" class="text-white text-3xl font-bold">-- GB</h3>
                        <p id="health-ram-total" class="text-gray-400 text-xs uppercase tracking-widest mt-1">RAM Usage
                        </p>
                    </div>
                    <!-- UPTIME -->
                    <div
                        class="glass-panel p-6 rounded-xl border border-white/5 flex flex-col items-center justify-center relative overflow-hidden">
                        <span class="material-symbols-outlined text-4xl text-blue-400 mb-2">timer</span>
                        <h3 id="health-uptime" class="text-white text-3xl font-bold">--</h3>
                        <p class="text-gray-400 text-xs uppercase tracking-widest mt-1">System Uptime</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="glass-panel p-6 rounded-xl border border-white/5">
                        <h3 class="font-bold text-white mb-6">Service Status</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Database (PostgreSQL)</span>
                                <span
                                    class="bg-system-green/10 text-system-green px-2 py-0.5 rounded text-xs border border-system-green/20">Operational</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Cache (Redis)</span>
                                <span
                                    class="bg-system-green/10 text-system-green px-2 py-0.5 rounded text-xs border border-system-green/20">Operational</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Payment Gateway</span>
                                <span
                                    class="bg-system-yellow/10 text-system-yellow px-2 py-0.5 rounded text-xs border border-system-yellow/20">Degraded</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Email Service</span>
                                <span
                                    class="bg-system-green/10 text-system-green px-2 py-0.5 rounded text-xs border border-system-green/20">Operational</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= VIEW: AUDIT LOGS ================= -->
            <div id="view-audit" class="view-section">
                <div class="glass-panel rounded-xl overflow-hidden">
                    <div class="p-6 border-b border-white/5">
                        <h3 class="font-bold text-white">System Audit Logs</h3>
                    </div>
                    <div class="p-6 h-[600px] overflow-y-auto font-mono text-xs space-y-2" id="audit-log-container">
                        <!-- Logs injected here -->
                    </div>
                </div>
            </div>

            <!-- ================= VIEW: MENU REQUESTS ================= -->
            <div id="view-requests" class="view-section">
                <div class="glass-panel rounded-xl overflow-hidden">
                    <div class="p-6 border-b border-white/5">
                        <h3 class="font-bold text-white">Pending Menu Approvals</h3>
                    </div>
                    <div class="p-6" id="menu-requests-container">
                        <p class="text-gray-500">Loading requests...</p>
                    </div>
                </div>
            </div>

            <!-- ================= VIEW: GLOBAL CONFIG ================= -->
            <div id="view-config" class="view-section">
                <div class="glass-panel p-8 rounded-xl border border-white/5 max-w-3xl">
                    <h3 class="font-bold text-white mb-6 text-lg border-b border-white/5 pb-4">Global Configuration</h3>

                    <div class="space-y-8">
                        <!-- Toggle Group -->
                        <div>
                            <h4 class="text-sm font-bold text-primary mb-4 uppercase tracking-wider">System State</h4>
                            <div
                                class="flex items-center justify-between p-4 bg-white/5 rounded-lg border border-white/5 mb-4">
                                <div>
                                    <div class="text-white font-medium">Maintenance Mode</div>
                                    <div class="text-xs text-gray-500">Enable to block all tenant access.</div>
                                </div>
                                <div
                                    class="relative inline-block w-10 h-6 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" id="maintenance-toggle" onchange="toggleMaintenance(this)"
                                        class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer bg-gray-500 right-4" />
                                    <label for="maintenance-toggle"
                                        class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                                </div>
                            </div>
                            <div
                                class="flex items-center justify-between p-4 bg-white/5 rounded-lg border border-white/5">
                                <div>
                                    <div class="text-white font-medium">New Registrations</div>
                                    <div class="text-xs text-gray-500">Allow new restaurants to sign up.</div>
                                </div>
                                <div
                                    class="relative inline-block w-10 h-6 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" id="registrations-toggle"
                                        onchange="toggleRegistrations(this)" checked
                                        class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer right-0 border-primary" />
                                    <label for="registrations-toggle"
                                        class="toggle-label block overflow-hidden h-6 rounded-full bg-primary cursor-pointer"></label>
                                </div>
                            </div>
                        </div>

                        <!-- Inputs -->
                        <div>
                            <h4 class="text-sm font-bold text-primary mb-4 uppercase tracking-wider">Integrations
                                (Stripe/Razorpay)</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Live API Key</label>
                                    <input type="password" value="sk_live_XXXXXXXXXXXXXXXXXXXX"
                                        class="w-full bg-bg-soft border border-white/10 rounded px-4 py-2 text-sm text-gray-300 focus:outline-none focus:border-primary font-mono">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Webhook Secret</label>
                                    <input type="password" value="whsec_XXXXXXXXXXXXXXXXXXXX"
                                        class="w-full bg-bg-soft border border-white/10 rounded px-4 py-2 text-sm text-gray-300 focus:outline-none focus:border-primary font-mono">
                                </div>
                            </div>
                            <div class="mt-4 text-right">
                                <button onclick="showAlert('System configuration saved successfully!')"
                                    class="bg-primary text-black font-bold px-6 py-2 rounded hover:bg-white transition-colors">Save
                                    Changes</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- GENERIC MODAL -->
    <div id="generic-modal" class="fixed inset-0 z-[100] hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop">
        </div>
        <!-- Content -->
        <div class="absolute inset-0 flex items-center justify-center p-4 z-10 pointer-events-none">
            <div id="modal-panel"
                class="bg-[#1a1a1a] border border-white/10 rounded-2xl w-full max-w-md transform scale-95 opacity-0 transition-all duration-300 shadow-2xl relative overflow-hidden pointer-events-auto">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-white/5 flex justify-between items-center bg-white/5">
                    <h3 id="modal-title" class="text-lg font-bold text-white tracking-tight">Add New Item</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <!-- Body -->
                <div class="p-6 space-y-4" id="modal-body">
                    <!-- Dynamic Inputs -->
                </div>
                <!-- Footer -->
                <div class="px-6 py-4 border-t border-white/5 flex justify-end gap-3 bg-white/5">
                    <button onclick="closeModal()"
                        class="px-4 py-2 text-xs font-bold text-gray-400 hover:text-white transition-colors">Cancel</button>
                    <button id="modal-submit-btn"
                        class="bg-primary text-black px-6 py-2 rounded text-xs font-bold hover:bg-white transition-colors shadow-lg shadow-primary/20 cursor-pointer">Create</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- UTILS ---
        function switchTab(tabId) {
            // 1. Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));

            // 2. Show active view
            const activeView = document.getElementById('view-' + tabId);
            if (activeView) activeView.classList.add('active');

            // 3. Update Sidebar Active State
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            const navLink = document.getElementById('nav-' + tabId);
            if (navLink) navLink.classList.add('active');

            // 4. Update Header Title
            const titles = {
                'overview': 'Platform Overview',
                'restaurants': 'Restaurant Management',
                'users': 'User Accounts',
                'health': 'System Health',
                'audit': 'Audit Logs',
                'requests': 'Menu Requests',
                'config': 'Global Configuration'
            };
            const titleEl = document.getElementById('page-title');
            if (titleEl) titleEl.textContent = titles[tabId] || 'Admin';

            // 5. Contextual Fetches
            if (tabId === 'audit') fetchAuditLogs();
            if (tabId === 'requests') fetchMenuRequests();
        }


        // --- AUTHENTICATION & DATA ISOLATION ---
        const userSession = localStorage.getItem('user');
        let currentUser = null;

        try {
            currentUser = JSON.parse(userSession);
        } catch (e) {
            console.error("Invalid session");
        }

        if (!currentUser || currentUser.role !== 'admin') {
            window.location.href = "../Final-login-Page/index.html"; // Redirect to login
        }

        // Global Fetch Interceptor to inject JWT Token
        const originalFetch = window.fetch;
        window.fetch = function (url, options = {}) {
            const token = localStorage.getItem('token');
            options.headers = options.headers || {};
            if (token) {
                if (options.headers instanceof Headers) {
                    options.headers.set('Authorization', `Bearer ${token}`);
                } else {
                    options.headers['Authorization'] = `Bearer ${token}`;
                }
            }
            return originalFetch(url, options);
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Update Profile Info in UI
            const nameEl = document.querySelector(".text-right .text-sm");
            const roleEl = document.querySelector(".text-right .text-xs");
            if (nameEl) nameEl.textContent = currentUser.name || "Admin";
            if (roleEl) roleEl.textContent = currentUser.role || "Administrator";

            fetchAdminStats();
            fetchRestaurants();
            fetchUsers();
            fetchConfig();
            // Default load
            switchTab('overview');
        });

        async function fetchAdminStats() {
            try {
                const res = await fetch('/api/v1/stats/admin');
                const data = await res.json();

                // 1. Overview Stats
                document.getElementById('stat-mrr').textContent = '‚Çπ' + (data.mrr / 100000).toFixed(1) + 'L';
                document.getElementById('stat-active-restaurants').textContent = data.active_restaurants;
                document.getElementById('stat-total-users').textContent = data.total_users;

                // Handle new health object logic
                if (typeof data.server_health === 'object') {
                    document.getElementById('stat-health').textContent = data.server_health.summary;

                    const health = data.server_health;

                    // Populate Detailed Health View with Real Data
                    const cpuCountEl = document.getElementById('health-cpu-count');
                    if (cpuCountEl) cpuCountEl.textContent = `${health.cpu.count} Cores`;

                    const cpuModelEl = document.getElementById('health-cpu-model');
                    if (cpuModelEl) cpuModelEl.textContent = health.cpu.model;

                    const osEl = document.getElementById('health-os');
                    if (osEl) osEl.textContent = health.os.platform;

                    const ramValEl = document.getElementById('health-ram-usage');
                    const ramTotalEl = document.getElementById('health-ram-total');
                    if (ramValEl) {
                        const usedGB = ((health.memory.total - health.memory.free) / 1073741824).toFixed(2);
                        const totalGB = (health.memory.total / 1073741824).toFixed(0);
                        ramValEl.textContent = `${usedGB} GB`;
                        ramTotalEl.textContent = `RAM / ${totalGB} GB`;
                    }

                    const uptimeEl = document.getElementById('health-uptime');
                    if (uptimeEl) {
                        // Format seconds to readable time
                        const totalSeconds = health.uptime_seconds;
                        const hours = Math.floor(totalSeconds / 3600);
                        const minutes = Math.floor((totalSeconds % 3600) / 60);
                        uptimeEl.textContent = `${hours}h ${minutes}m`;
                    }
                } else {
                    document.getElementById('stat-health').textContent = data.server_health;
                }

            } catch (e) { console.error(e); }
        }

        async function deleteRestaurant(id) {
            if (!await showConfirm("Are you sure you want to delete this restaurant? Data will be lost.")) return;
            await fetch(`/api/v1/restaurants/${id}`, { method: 'DELETE' });
            fetchRestaurants();
            fetchAdminStats();
        }

        // --- MODAL SYSTEM ---
        let currentModalResolve = null;

        function openModal({ title, fields, submitLabel = 'Create' }) {
            return new Promise((resolve) => {
                const modal = document.getElementById('generic-modal');
                const backdrop = document.getElementById('modal-backdrop');
                const panel = document.getElementById('modal-panel');
                const titleEl = document.getElementById('modal-title');
                const bodyEl = document.getElementById('modal-body');
                const submitBtn = document.getElementById('modal-submit-btn');

                // Set Content
                titleEl.textContent = title;
                submitBtn.textContent = submitLabel;
                bodyEl.innerHTML = '';

                // Generate Fields
                fields.forEach(field => {
                    const div = document.createElement('div');
                    // CHECK FOR DEFAULT VALUE
                    const valueAttr = field.defaultValue ? `value="${field.defaultValue}"` : '';

                    div.innerHTML = `
    <label class="block text-xs uppercase tracking-wider text-gray-500 mb-1 font-semibold">${field.label}</label>
    ${field.type === 'select' ?
                            `<select name="${field.name}"
        class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-primary transition-colors">
        ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
    </select>` :
                            `<input type="${field.type}" name="${field.name}" placeholder="${field.placeholder || ''}" ${valueAttr}
        class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-primary transition-colors placeholder-gray-600">`
                        }
    `;
                    bodyEl.appendChild(div);
                });

                // Show Modal (Animation)
                modal.classList.remove('hidden');
                // Trigger reflow
                void modal.offsetWidth;
                backdrop.classList.remove('opacity-0');
                panel.classList.remove('opacity-0', 'scale-95');

                // Handle Submit Logic
                const handleSubmit = () => {
                    const formData = {};
                    const inputs = bodyEl.querySelectorAll('input, select');
                    let valid = true;
                    inputs.forEach(input => {
                        // Allow empty if not required (custom logic if needed, but for now strict)
                        if (!input.value) valid = false;
                        formData[input.name] = input.value;
                    });

                    if (valid) {
                        closeModal(formData);
                    } else {
                        // Shake animation for error
                        panel.classList.add('animate-pulse');
                        setTimeout(() => panel.classList.remove('animate-pulse'), 500);
                    }
                };

                submitBtn.onclick = handleSubmit;

                // Handle Enter Key on Inputs
                const inputs = bodyEl.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleSubmit();
                        }
                    });
                });

                // Focus first input
                if (inputs.length > 0) inputs[0].focus();

                currentModalResolve = resolve;
            });
        }

        function closeModal(result = null) {
            const modal = document.getElementById('generic-modal');
            const backdrop = document.getElementById('modal-backdrop');
            const panel = document.getElementById('modal-panel');

            backdrop.classList.add('opacity-0');
            panel.classList.add('opacity-0', 'scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
                if (currentModalResolve) {
                    currentModalResolve(result);
                    currentModalResolve = null;
                }
            }, 300);
        }

        // --- PRETTIER DIALOGS ---
        function showConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('generic-modal');
                const backdrop = document.getElementById('modal-backdrop');
                const panel = document.getElementById('modal-panel');
                const titleEl = document.getElementById('modal-title');
                const bodyEl = document.getElementById('modal-body');
                const submitBtn = document.getElementById('modal-submit-btn');

                titleEl.textContent = "Confirm Action";
                bodyEl.innerHTML = `<p class="text-white text-sm">${message}</p>`;
                submitBtn.textContent = "Confirm";

                // Show
                modal.classList.remove('hidden');
                void modal.offsetWidth;
                backdrop.classList.remove('opacity-0');
                panel.classList.remove('opacity-0', 'scale-95');

                submitBtn.onclick = () => {
                    closeModal(true);
                };

                currentModalResolve = resolve;
            });
        }

        function showAlert(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('generic-modal');
                const backdrop = document.getElementById('modal-backdrop');
                const panel = document.getElementById('modal-panel');
                const titleEl = document.getElementById('modal-title');
                const bodyEl = document.getElementById('modal-body');
                const submitBtn = document.getElementById('modal-submit-btn');

                titleEl.textContent = "Message";
                bodyEl.innerHTML = `<p class="text-white text-sm">${message}</p>`;
                submitBtn.textContent = "OK";

                modal.classList.remove('hidden');
                void modal.offsetWidth;
                backdrop.classList.remove('opacity-0');
                panel.classList.remove('opacity-0', 'scale-95');

                submitBtn.onclick = () => {
                    closeModal(true);
                };
                currentModalResolve = resolve;
            });
        }

        // --- ACTIONS ---
        async function createRestaurant() {
            const data = await openModal({
                title: 'Add New Restaurant',
                fields: [
                    { name: 'name', label: 'Restaurant Name', type: 'text', placeholder: 'e.g. Spice Garden' },
                    { name: 'location', label: 'Location', type: 'text', placeholder: 'e.g. Mumbai, IN' },
                    { name: 'plan', label: 'Subscription Plan', type: 'select', options: ['Standard', 'Premium'] }
                ]
            });

            if (!data) return; // Cancelled

            await fetch("/api/v1/restaurants", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            fetchRestaurants();
            fetchAdminStats();
        }

        async function fetchConfig() {
            try {
                const res = await fetch('/api/v1/admin/config');
                const config = await res.json();

                const toggle = document.getElementById('maintenance-toggle');
                if (toggle) {
                    toggle.checked = config.maintenance_mode === 'true';
                }

                const regToggle = document.getElementById('registrations-toggle');
                if (regToggle) {
                    regToggle.checked = config.allow_registrations === 'true';
                }
            } catch (e) { console.error(e); }
        }

        async function toggleMaintenance(el) {
            const isEnabled = el.checked;
            await fetch('/api/v1/admin/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: 'maintenance_mode', value: isEnabled })
            });
            await showAlert(isEnabled ? "System is now in Maintenance Mode. Only Admins can log in." : "Maintenance Mode Disabled. Users can log in.");
        }

        async function toggleRegistrations(el) {
            const isEnabled = el.checked;
            await fetch('/api/v1/admin/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: 'allow_registrations', value: isEnabled })
            });
            await showAlert(isEnabled ? "New restaurant registrations are now ALLOWED." : "New registrations are now DISABLED.");
        }

        async function createUser() {
            const data = await openModal({
                title: 'Create New User',
                fields: [
                    { name: 'name', label: 'Full Name', type: 'text', placeholder: 'e.g. John Doe' },
                    { name: 'email', label: 'Email Address', type: 'email', placeholder: 'e.g. john@example.com' },
                    { name: 'password', label: 'Password', type: 'password', placeholder: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' },
                    { name: 'role', label: 'Role', type: 'select', options: ['owner', 'admin', 'manager'] }
                ],
                submitLabel: 'Create User'
            });

            if (!data) return;

            try {
                const res = await fetch("/api/v1/admin/users", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    fetchUsers();
                    fetchAdminStats();
                } else {
                    await showAlert("Error: " + result.message);
                }
            } catch (e) { console.error(e); }
        }

        async function deleteUser(id) {
            if (!await showConfirm("Are you sure you want to remove this user? This cannot be undone.")) return;
            try {
                const res = await fetch(`/api/v1/admin/users/${id}`, { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    await showAlert("User deleted successfully.");
                    fetchUsers();
                    fetchAdminStats();
                } else {
                    await showAlert("Failed to delete user: " + (data.message || "Unknown error"));
                }
            } catch (e) {
                console.error(e);
                await showAlert("Error connecting to server.");
            }
        }

        async function fetchRestaurants() {
            try {
                const res = await fetch('/api/v1/restaurants');
                const data = await res.json();

                // Update Top Restaurants Logic
                updateTopRestaurants(data);

                const tbody = document.getElementById('restaurants-table-body');
                tbody.innerHTML = '';

                data.forEach(r => {
                    tbody.innerHTML += `
    <tr class="hover:bg-white/5 transition-colors group">
        <td class="px-6 py-4">
            <div class="flex items-center gap-3">
                <div class="size-8 rounded bg-gray-700"></div>
                <div>
                    <div class="font-bold text-white">${r.name}</div>
                    <div class="text-xs text-gray-500">${r.location}</div>
                </div>
            </div>
        </td>
        <td class="px-6 py-4">${r.location.split(',')[0]}</td>
        <td class="px-6 py-4"><span
                class="bg-primary/10 text-primary text-xs px-2 py-1 rounded border border-primary/20">${r.plan}</span>
        </td>
        <td class="px-6 py-4"><span class="text-system-green text-xs font-bold">${r.status}</span></td>
        <td class="px-6 py-4 text-white">‚Çπ${(r.revenue / 1000).toFixed(1)}K</td>
        <td class="px-6 py-4 text-right">
            <button onclick="deleteRestaurant('${r.id}')"
                class="bg-white/5 hover:bg-white/10 px-2 py-1 rounded text-xs border border-white/10 text-red-400 hover:text-red-300">Delete</button>
        </td>
    </tr>
    `;
                });
            } catch (e) { console.error(e); }
        }

        function updateTopRestaurants(restaurants) {
            try {
                const tbody = document.getElementById('top-restaurants-body');
                if (!tbody) return;
                tbody.innerHTML = '';

                const top = [...restaurants].sort((a, b) => b.revenue - a.revenue).slice(0, 3);

                top.forEach(r => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-white/5 transition-colors">
                            <td class="px-6 py-4 font-bold text-white">${r.name}</td>
                            <td class="px-6 py-4">‚Çπ${(r.revenue / 1000).toFixed(1)}K</td>
                            <td class="px-6 py-4"><span class="text-system-green text-xs font-bold">${r.status}</span></td>
                        </tr>
                     `;
                });

                if (top.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-gray-500 text-center">No active restaurants</td></tr>';
                }
            } catch (e) { console.error("Error updating top restaurants", e); }
        }

        async function fetchMenuRequests() {
            try {
                const res = await fetch("/api/v1/admin/menu/pending");
                const requests = await res.json();
                const container = document.getElementById("menu-requests-container");

                if (requests.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 italic">No pending requests.</p>';
                } else {
                    container.innerHTML = `<div class="grid grid-cols-1 gap-4">` + requests.map(item => `
        <div class="glass-panel p-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div
                    class="size-12 bg-gray-700 rounded-lg flex items-center justify-center font-bold text-gray-500 text-lg">
                    ${item.name[0]}</div>
                <div>
                    <h4 class="text-white font-bold">${item.name}</h4>
                    <p class="text-xs text-gray-400">${item.category} - ‚Çπ${item.price}</p>
                    <p class="text-xs text-primary mt-1">From: <span class="font-bold text-white">${item.restaurantId ? item.restaurantId.name : 'Unknown'}</span></p>
                </div>
            </div>

            <div class="flex items-center gap-4 w-full md:w-auto">
                <div class="flex-1 md:flex-none">
                    <label class="block text-[10px] text-gray-500 mb-1 uppercase tracking-wider">Admin: Add
                        Image</label>
                    <input type="file" id="file-${item.id}" accept="image/*"
                        class="text-xs text-gray-400 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-white/10 file:text-white hover:file:bg-white/20" />
                </div>
                <div class="flex gap-2">
                    <button onclick="approveMenu('${item.id}')"
                        class="bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded text-xs font-bold transition-colors">Approve</button>
                    <button onclick="rejectMenu('${item.id}')"
                        class="bg-red-600 hover:bg-red-500 text-white px-3 py-1.5 rounded text-xs font-bold transition-colors">Reject</button>
                </div>
            </div>
        </div>
        `).join('') + `
    </div>`;
                }
            } catch (err) { console.error("Requests error", err); }
        }

        async function approveMenu(id) {
            if (!await showConfirm("Approve this item?")) return;

            let image_url = null;
            const fileInput = document.getElementById(`file-${id}`);

            if (fileInput && fileInput.files[0]) {
                try {
                    image_url = await toBase64(fileInput.files[0]);
                } catch (e) {
                    await showAlert("Error processing image");
                    return;
                }
            }

            await fetch(`/api/v1/admin/menu/${id}/approve`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_url })
            });
            fetchMenuRequests();
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        async function rejectMenu(id) {
            if (!await showConfirm("Reject (Delete) this item?")) return;
            await fetch(`/api/v1/admin/menu/${id}/reject`, { method: 'DELETE' });
            fetchMenuRequests();
        }

        async function fetchUsers() {
            try {
                const res = await fetch('/api/v1/admin/users');
                const data = await res.json();

                const pendingTbody = document.getElementById('users-pending-table-body');
                const activeTbody = document.getElementById('users-active-table-body');
                const pendingPanel = document.getElementById('pending-users-panel');

                // Clear tables
                pendingTbody.innerHTML = '';
                activeTbody.innerHTML = '';

                let pendingCount = 0;

                data.forEach(u => {
                    const status = u.status || 'active'; // Default to active if null
                    let statusColor = 'text-system-green';
                    if (status === 'suspended') statusColor = 'text-system-red';

                    // 1. PENDING USER
                    if (status === 'pending') {
                        pendingCount++;
                        pendingTbody.innerHTML += `
    <tr class="hover:bg-white/5 transition-colors">
        <td class="px-6 py-4 flex items-center gap-3">
            <div
                class="size-8 rounded-full bg-yellow-500/20 text-yellow-500 flex items-center justify-center font-bold border border-yellow-500/30">
                ?</div>
            <div class="text-white font-medium">
                ${u.name}
                <div class="text-[10px] text-gray-500">${u.email}</div>
            </div>
        </td>
        <td class="px-6 py-4"><span
                class="text-gray-400 text-xs border border-white/10 px-2 py-1 rounded">${u.role}</span></td>
        <td class="px-6 py-4 text-gray-500 text-xs">Awaiting Approval</td>
        <td class="px-6 py-4 text-right">
            <button onclick="approveUser('${u.id}')"
                class="bg-system-green/10 hover:bg-system-green/20 text-system-green px-3 py-1.5 rounded text-xs font-bold transition-colors border border-system-green/20 mr-2">Approve</button>
            <button onclick="deleteUser('${u.id}')"
                class="bg-red-500/10 hover:bg-red-500/20 text-red-400 px-3 py-1.5 rounded text-xs font-bold transition-colors border border-red-500/20">Reject</button>
        </td>
    </tr>
    `;
                    }
                    // 2. ACTIVE / OTHER USER
                    else {
                        activeTbody.innerHTML += `
    <tr class="hover:bg-white/5 transition-colors">
        <td class="px-6 py-4 flex items-center gap-3">
            <div class="size-8 rounded-full bg-gradient-to-br from-primary to-primary-dark"></div>
            <div class="text-white font-medium">
                ${u.name}
                <div class="text-[10px] text-gray-500">${u.email}</div>
            </div>
        </td>
        <td class="px-6 py-4"><span
                class="text-primary font-bold text-xs uppercase border border-primary/30 px-2 py-1 rounded bg-primary/5">${u.role}</span>
        </td>
        <td class="px-6 py-4">--</td>
        <td class="px-6 py-4"><span class="${statusColor} font-bold capitalize">${status}</span></td>
        <td class="px-6 py-4 text-right">
            <button onclick="deleteUser('${u.id}')" class="text-xs text-red-400 hover:text-red-300">Revoke Access</button>
        </td>
    </tr>
    `;
                    }
                });

                // Toggle Pending Panel Visibility
                if (pendingCount > 0) {
                    pendingPanel.classList.remove('hidden');
                } else {
                    pendingPanel.classList.add('hidden');
                }

            } catch (e) { console.error(e); }
        }

        async function approveUser(id) {
            if (!await showConfirm("Approve this user? They will be able to log in immediately.")) return;
            try {
                const res = await fetch(`/api/v1/admin/users/${id}/approve`, { method: 'PUT' });
                const data = await res.json();
                if (data.success) {
                    fetchUsers();
                    fetchAdminStats(); // Update pending count if any
                } else {
                    await showAlert("Failed: " + data.message);
                }
            } catch (e) {
                console.error(e);
                await showAlert("Error approving user");
            }
        }

        async function fetchAuditLogs() {
            try {
                const res = await fetch('/api/v1/admin/logs');
                const data = await res.json();

                const container = document.getElementById('audit-log-container');
                if (!container) return;

                container.innerHTML = ''; // Clear static logs

                if (data.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 italic">No logs found.</p>';
                }

                data.forEach(log => {
                    let color = 'bg-white/20'; // info
                    if (log.severity === 'success') color = 'bg-system-green';
                    if (log.severity === 'warning') color = 'bg-system-yellow';
                    if (log.severity === 'important') color = 'bg-system-red';

                    container.innerHTML += `
                    <div class="ml-6 relative pl-4 border-l border-white/10 pb-4 last:border-0 last:pb-0">
                        <span class="absolute -left-[5px] top-0 bg-bg-deep border border-white/20 size-2.5 rounded-full ${color}"></span>
                        <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-4 mb-1">
                            <span class="text-xs text-gray-500 font-mono">${new Date(log.timestamp).toLocaleString()}</span>
                            <span class="text-white font-bold">${log.action}</span>
                        </div>
                        <p class="text-gray-400 text-xs">${log.details}</p>
                        ${log.userId ? `<div class="text-[10px] text-gray-600 mt-1">By: ${log.userId.email}</div>` : ''}
                    </div>
                    `;
                });

            } catch (e) { console.error(e); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchAdminStats();
            fetchRestaurants();
            fetchUsers();
            fetchConfig();
            fetchAuditLogs();
            fetchMenuRequests();
        });
    </script>
</body>

</html>